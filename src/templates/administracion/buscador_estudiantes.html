{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Buscador de Estudiantes - Admin{% endblock %}

{% block user_role %}Administrador{% endblock %}

{% block sidebar_menu %}
<li><a href="{% url 'dashboard_admin' %}"><i class="fa-solid fa-home"></i> Inicio</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'administracion:panel_cursos' %}"><i class="fa-solid fa-book"></i> Gestión Cursos</a></li>
<li><a href="{% url 'administracion:panel_comisiones' %}"><i class="fa-solid fa-users-rectangle"></i> Gestión Comisiones</a></li>
{% endif %}
<li><a href="{% url 'administracion:panel_inscripciones' %}"><i class="fa-solid fa-clipboard-list"></i> Inscripciones</a></li>
{% if es_admin_completo or es_mesa_entrada %}
<li><a href="{% url 'empresas:mesa_entrada_list' %}"><i class="fa-solid fa-building"></i> Solicitudes Empresas</a></li>
{% endif %}
{% if es_admin_completo %}
<li><a href="{% url 'empresas:gestion_empresas' %}"><i class="fa-solid fa-building"></i> Gestión Empresas</a></li>
<li><a href="{% url 'empresas:turnos_admin' %}"><i class="fa-solid fa-calendar"></i> Turnos Empresas</a></li>
{% endif %}
{% if es_admin_completo or es_mesa_entrada %}
<li><a href="{% url 'empresas:turnos_hoy' %}"><i class="fa-solid fa-calendar-check"></i> Asistencia Empresas</a></li>
{% endif %}
{% if es_admin_completo %}
<li><a href="{% url 'administracion:gestion_usuarios' %}"><i class="fa-solid fa-users-cog"></i> Gestión Usuarios</a></li>
{% endif %}
<li><a href="{% url 'administracion:buscador_estudiantes' %}" class="active"><i class="fa-solid fa-search"></i> Buscar Estudiantes</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'administracion:panel_polos' %}"><i class="fa-solid fa-map-marker-alt"></i> Polos</a></li>
{% endif %}
{% if es_admin_completo %}
<li><a href="{% url 'administracion:estadisticas' %}"><i class="fa-solid fa-chart-bar"></i> Estadísticas</a></li>
{% endif %}
<li><a href="{% url 'administracion:panel_asistencia' %}"><i class="fa-solid fa-calendar-check"></i> Asistencias</a></li>
<li><a href="{% url 'usuario:mi_perfil' %}"><i class="fa-solid fa-user"></i> Mi Perfil</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'admin:index' %}"><i class="fa-solid fa-cogs"></i> Django Admin</a></li>
{% endif %}
{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h2 style="font-size: 2.2rem; color: #1e293b; margin-bottom: 0.5rem;">Buscador de Estudiantes</h2>
    <p style="color: #64748b; font-size: 1.1rem;">Encuentra estudiantes por nombre, apellido, DNI o correo electrónico.</p>
    
    <div class="estudiantes-toolbar" style="display: flex; gap: 1rem; margin-top: 1.5rem; align-items: center; flex-wrap: wrap;">
        <input 
            type="text" 
            id="searchInput" 
            placeholder="Escribe para buscar... (mínimo 2 caracteres)" 
            class="estudiantes-search-input"
            style="flex: 1; min-width: 300px; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.05);"
            autocomplete="off"
        >
        <div id="loadingIndicator" style="display: none; color: #64748b; font-weight: 600;">
            Buscando...
        </div>
        <a href="{% url 'administracion:exportar_estudiantes' %}" style="background: #f97316; color: white; padding: 1rem 1.5rem; border-radius: 12px; text-decoration: none; font-weight: 700; display: inline-block; box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.2); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 15px -3px rgba(249, 115, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(249, 115, 22, 0.2)'" target="_blank">
            <i class="fa-solid fa-file-excel"></i> Exportar a Excel
        </a>
    </div>
    <div style="margin-top: 1rem; color: #94a3b8; font-size: 0.9rem;">
        Tip: La búsqueda se actualiza automáticamente mientras escribes
    </div>
</div>

<div id="resultadosContainer">
    <div id="emptyState" class="empty-state">
        <p>Escribe en el buscador para encontrar estudiantes.</p>
    </div>
</div>

<div id="resultadosTabla" style="display: none; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
    <div style="padding: 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
        <h3 style="margin: 0; color: #334155; font-size: 1.2rem;">
            Resultados: <span id="cantidadResultados">0</span> estudiante(s) encontrado(s)
        </h3>
    </div>
    <div class="estudiantes-table-scroll">
        <table class="estudiantes-table" style="width: 100%; border-collapse: collapse;">
            <thead style="background: #f8fafc;">
                <tr>
                    <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">DNI</th>
                    <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Nombre Completo</th>
                    <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Email</th>
                    <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Edad</th>
                    <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Ciudad</th>
                    <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Nivel Estudios</th>
                    <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Inscripciones</th>
                    <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Acciones</th>
                </tr>
            </thead>
            <tbody id="resultadosBody">
            </tbody>
        </table>
    </div>
</div>

<div id="detalleEstudianteModal" class="modal-overlay" style="z-index: 10050; display: none;">
    <div class="modal-container" style="max-width: 900px; padding: 0; max-height: 85vh; overflow: hidden;">
        <button class="modal-close" onclick="closeDetalleEstudianteModal()">×</button>
        <div style="padding: 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
            <h3 id="detalleNombre" style="margin: 0; color: #1e293b; font-size: 1.4rem; font-weight: 800;"></h3>
            <div id="detalleSub" style="margin-top: 0.35rem; color: #64748b; font-weight: 600;"></div>
        </div>
        <div id="detalleBody" style="padding: 1.5rem; overflow: auto; max-height: calc(85vh - 90px);"></div>
    </div>
</div>

<style>
    .empty-state {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        margin-top: 2rem;
    }
    .empty-state .icon {
        font-size: 4rem;
        color: #cbd5e1;
        margin-bottom: 1rem;
    }
    .empty-state p {
        font-size: 1.1rem;
        color: #64748b;
        margin-bottom: 1.5rem;
    }
    .btn-primary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.8rem 1.5rem;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 700;
        display: inline-block;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        opacity: 0.9;
        transform: translateY(-2px);
    }
    #searchInput:focus {
        outline: none;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
    }
    tbody tr {
        border-bottom: 1px solid #f1f5f9;
        transition: background 0.2s ease;
    }
    tbody tr:hover {
        background: #f8fafc;
    }
    tbody td {
        padding: 1rem 1.5rem;
        color: #334155;
    }
    .highlight {
        background: #fef3c7;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-weight: 600;
    }

    .estudiantes-table-scroll {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .estudiantes-table {
        min-width: 980px;
    }

    @media (max-width: 768px) {
        .estudiantes-search-input {
            min-width: 0 !important;
            width: 100%;
        }
    }

    @media (max-width: 480px) {
        .estudiantes-toolbar a {
            width: 100%;
            text-align: center;
        }
    }
</style>

<script>
    let timeoutId = null;
    const searchInput = document.getElementById('searchInput');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const emptyState = document.getElementById('emptyState');
    const resultadosTabla = document.getElementById('resultadosTabla');
    const resultadosBody = document.getElementById('resultadosBody');
    const cantidadResultados = document.getElementById('cantidadResultados');

    const detalleEstudianteModal = document.getElementById('detalleEstudianteModal');
    const detalleNombre = document.getElementById('detalleNombre');
    const detalleSub = document.getElementById('detalleSub');
    const detalleBody = document.getElementById('detalleBody');
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Limpiar timeout anterior
        if (timeoutId) {
            clearTimeout(timeoutId);
        }
        
        // Si la búsqueda es muy corta, mostrar estado vacío
        if (query.length < 2) {
            emptyState.style.display = 'block';
            resultadosTabla.style.display = 'none';
            emptyState.innerHTML = `
                <p>Escribe al menos 2 caracteres para buscar.</p>
            `;
            return;
        }
        
        // Mostrar indicador de carga
        loadingIndicator.style.display = 'block';
        
        // Esperar 500ms antes de hacer la búsqueda (debounce)
        timeoutId = setTimeout(() => {
            buscarEstudiantes(query);
        }, 500);
    });
    
    async function buscarEstudiantes(query) {
        try {
            const response = await fetch(`{% url 'administracion:api_buscar_estudiantes' %}?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            loadingIndicator.style.display = 'none';
            
            if (data.estudiantes.length === 0) {
                emptyState.style.display = 'block';
                resultadosTabla.style.display = 'none';
                emptyState.innerHTML = `
                    <p>No se encontraron estudiantes con "<strong>${query}</strong>".</p>
                `;
                return;
            }
            
            // Mostrar resultados
            emptyState.style.display = 'none';
            resultadosTabla.style.display = 'block';
            cantidadResultados.textContent = data.estudiantes.length;
            
            // Construir tabla
            resultadosBody.innerHTML = '';
            data.estudiantes.forEach(est => {
                const row = document.createElement('tr');
                const dni = escapeHtml(est.dni);
                row.innerHTML = `
                    <td><strong>${dni}</strong></td>
                    <td>${escapeHtml(est.nombre_completo)}</td>
                    <td>${escapeHtml(est.correo)}</td>
                    <td>${escapeHtml(est.edad)}</td>
                    <td>${escapeHtml(est.ciudad)}</td>
                    <td>${escapeHtml(est.nivel_estudios)}</td>
                    <td>
                        <span style="background: #dbeafe; color: #1e40af; padding: 0.4rem 0.8rem; border-radius: 8px; font-weight: 600; font-size: 0.85rem;">
                            ${escapeHtml(est.inscripciones)}
                        </span>
                    </td>
                    <td>
                        <button type="button" class="btn-primary" style="padding: 0.5rem 0.9rem; font-size: 0.85rem;" onclick="openDetalleEstudianteModal('${dni}')">Ver detalle</button>
                    </td>
                `;
                resultadosBody.appendChild(row);
            });
            
        } catch (error) {
            console.error('Error al buscar:', error);
            loadingIndicator.style.display = 'none';
            emptyState.style.display = 'block';
            resultadosTabla.style.display = 'none';
            emptyState.innerHTML = `
                
                <p>Error al realizar la búsqueda. Por favor, intenta de nuevo.</p>
            `;
        }
    }

    function escapeHtml(value) {
        return String(value ?? '').replace(/[&<>'"]/g, function (c) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;'
            }[c];
        });
    }

    function openDetalleEstudianteModal(dni) {
        detalleNombre.textContent = '';
        detalleSub.textContent = '';
        detalleBody.innerHTML = '<div style="color:#64748b; font-weight:700;">Cargando...</div>';

        detalleEstudianteModal.style.display = 'flex';
        detalleEstudianteModal.offsetHeight;
        detalleEstudianteModal.classList.add('show');
        document.body.style.overflow = 'hidden';

        fetch(`{% url 'administracion:api_detalle_estudiante' %}?dni=${encodeURIComponent(dni)}`)
            .then(async (r) => {
                const payload = await r.json().catch(() => ({}));
                if (!r.ok) {
                    throw new Error(payload && payload.error ? payload.error : 'No se pudo cargar el detalle.');
                }
                return payload;
            })
            .then((data) => {
                detalleNombre.textContent = data.nombre_completo || '';
                detalleSub.textContent = `DNI: ${data.dni || ''} • Email: ${data.correo || ''}`;

                const inscripciones = Array.isArray(data.inscripciones) ? data.inscripciones : [];
                const tutores = Array.isArray(data.tutores) ? data.tutores : [];
                const rows = inscripciones.map(i => {
                    return `<tr>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;"><strong>${escapeHtml(i.curso || '')}</strong></td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">#${escapeHtml(i.comision_id || '')}</td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">${escapeHtml(i.estado || '')}</td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">${escapeHtml(i.polo || '')}</td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">${escapeHtml(i.ciudad_polo || '')}</td>
                    </tr>`;
                }).join('');

                const tablaInsc = inscripciones.length ? `
                    <div style="overflow:auto; border:1px solid #e2e8f0; border-radius:12px;">
                        <table style="width:100%; border-collapse:collapse; background:#fff;">
                            <thead style="background:#f8fafc;">
                                <tr>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Curso</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Comisión</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Estado</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Polo</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Ciudad</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                ` : '<div style="color:#64748b; font-weight:700;">Sin inscripciones.</div>';

                const rowsTutores = tutores.map(t => {
                    const nombre = escapeHtml(t.nombre_completo || '');
                    const parentesco = escapeHtml(t.parentesco || '');
                    const tipo = escapeHtml(t.tipo_tutor || '');
                    const telefono = escapeHtml(t.telefono_contacto || '');
                    const correo = escapeHtml(t.correo || '');
                    const dniTutor = escapeHtml(t.dni || '');
                    const disponibilidad = escapeHtml(t.disponibilidad_horaria || '');
                    const fechaAsignacion = escapeHtml(t.fecha_asignacion || '');
                    const observaciones = escapeHtml(t.observaciones || '');

                    return `<tr>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;"><strong>${nombre}</strong></td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">${parentesco}</td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">${tipo}</td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">${telefono}</td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">${correo}</td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">${dniTutor}</td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">${disponibilidad}</td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">${fechaAsignacion}</td>
                        <td style="padding:0.6rem 0.75rem; border-bottom:1px solid #f1f5f9;">${observaciones}</td>
                    </tr>`;
                }).join('');

                const tablaTutores = tutores.length ? `
                    <div style="overflow:auto; border:1px solid #e2e8f0; border-radius:12px;">
                        <table style="width:100%; border-collapse:collapse; background:#fff;">
                            <thead style="background:#f8fafc;">
                                <tr>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Nombre</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Parentesco</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Tipo</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Teléfono</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Correo</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">DNI</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Disponibilidad</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Asignación</th>
                                    <th style="padding:0.6rem 0.75rem; text-align:left; color:#64748b; font-weight:800; border-bottom:1px solid #e2e8f0;">Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>${rowsTutores}</tbody>
                        </table>
                    </div>
                ` : '<div style="color:#64748b; font-weight:700;">Sin tutores registrados.</div>';

                detalleBody.innerHTML = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem;">
                        <div style="border:1px solid #e2e8f0; border-radius:12px; padding:1rem; background:#fff;">
                            <div style="font-weight:900; color:#0f172a; margin-bottom:0.5rem;">Salud</div>
                            <div style="white-space:pre-wrap; color:#475569;">${escapeHtml(data.condiciones_medicas || '')}</div>
                        </div>
                        <div style="border:1px solid #e2e8f0; border-radius:12px; padding:1rem; background:#fff;">
                            <div style="font-weight:900; color:#0f172a; margin-bottom:0.5rem;">Autorizaciones</div>
                            <div style="color:#475569; display:flex; flex-direction:column; gap:0.35rem;">
                                <div><strong>Imagen:</strong> ${data.autorizacion_imagen ? 'Sí' : 'No'}</div>
                                <div><strong>Voz:</strong> ${data.autorizacion_voz ? 'Sí' : 'No'}</div>
                            </div>
                        </div>
                        <div style="border:1px solid #e2e8f0; border-radius:12px; padding:1rem; background:#fff;">
                            <div style="font-weight:900; color:#0f172a; margin-bottom:0.5rem;">Estudios</div>
                            <div style="color:#475569; display:flex; flex-direction:column; gap:0.35rem;">
                                <div><strong>Nivel:</strong> ${escapeHtml(data.nivel_estudios || '')}</div>
                                <div><strong>Institución:</strong> ${escapeHtml(data.institucion_actual || '')}</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:1.25rem;">
                        <div style="font-weight:900; color:#0f172a; margin-bottom:0.75rem;">Tutores (${escapeHtml(data.total_tutores || tutores.length || 0)})</div>
                        ${tablaTutores}
                    </div>
                    <div style="margin-top:1.25rem;">
                        <div style="font-weight:900; color:#0f172a; margin-bottom:0.75rem;">Cursos inscriptos (${escapeHtml(data.total_inscripciones || 0)})</div>
                        ${tablaInsc}
                    </div>
                `;
            })
            .catch((err) => {
                detalleBody.innerHTML = `<div style="color:#ef4444; font-weight:800;">${escapeHtml(err.message || 'No se pudo cargar el detalle.')}</div>`;
            });
    }

    function closeDetalleEstudianteModal() {
        detalleEstudianteModal.classList.remove('show');
        setTimeout(() => { detalleEstudianteModal.style.display = 'none'; document.body.style.overflow = 'auto'; }, 250);
    }

    window.addEventListener('click', function(event) {
        if (event.target === detalleEstudianteModal) {
            closeDetalleEstudianteModal();
        }
    });

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && detalleEstudianteModal && detalleEstudianteModal.classList.contains('show')) {
            closeDetalleEstudianteModal();
        }
    });

    // Focus automático en el input al cargar
    searchInput.focus();
</script>
{% endblock %}


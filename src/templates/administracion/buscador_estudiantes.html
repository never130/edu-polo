{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Buscador de Estudiantes - Admin{% endblock %}

{% block user_role %}Administrador{% endblock %}

{% block sidebar_menu %}
<li><a href="{% url 'dashboard_admin' %}"> Inicio</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'administracion:panel_cursos' %}"> Gestión Cursos</a></li>
<li><a href="{% url 'administracion:panel_comisiones' %}"> Gestión Comisiones</a></li>
{% endif %}
<li><a href="{% url 'administracion:panel_inscripciones' %}"> Inscripciones</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'administracion:gestion_usuarios' %}"> Gestión Usuarios</a></li>
{% endif %}
<li><a href="{% url 'administracion:buscador_estudiantes' %}" class="active"> Buscar Estudiantes</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'administracion:panel_polos' %}"> Polos</a></li>
{% endif %}
<li><a href="{% url 'administracion:estadisticas' %}"> Estadísticas</a></li>
<li><a href="{% url 'administracion:panel_asistencia' %}"> Asistencias</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'administracion:docentes_cursos' %}"> Docentes y Cursos</a></li>
{% endif %}
<li><a href="{% url 'usuario:mi_perfil' %}"> Mi Perfil</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'admin:index' %}"> Django Admin</a></li>
{% endif %}
{% endblock %}

{% block content %}
<div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 2.5rem; border-radius: 20px; color: white; margin-bottom: 2rem;">
    <h2 style="font-size: 2.2rem;">Buscador de Estudiantes</h2>
    <p>Encuentra estudiantes por nombre, apellido, DNI o correo electrónico.</p>
    
    <div style="display: flex; gap: 1rem; margin-top: 1.5rem; align-items: center;">
        <input 
            type="text" 
            id="searchInput" 
            placeholder="Escribe para buscar... (mínimo 2 caracteres)" 
            style="flex: 1; padding: 1rem; border: none; border-radius: 12px; font-size: 1rem;"
            autocomplete="off"
        >
        <div id="loadingIndicator" style="display: none; color: white; font-weight: 600;">
            Buscando...
        </div>
    </div>
    <div style="margin-top: 1rem; color: rgba(255,255,255,0.9); font-size: 0.9rem;">
        Tip: La búsqueda se actualiza automáticamente mientras escribes
    </div>
</div>

<div style="text-align: right; margin-bottom: 1rem;">
    <a href="{% url 'administracion:exportar_estudiantes' %}" class="btn btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.8rem 1.5rem; border-radius: 12px; text-decoration: none; font-weight: 700; display: inline-block;">
        Exportar a Excel
    </a>
</div>

<div id="resultadosContainer">
    <div id="emptyState" class="empty-state">
        <p>Escribe en el buscador para encontrar estudiantes.</p>
    </div>
</div>

<div id="resultadosTabla" style="display: none; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
    <div style="padding: 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
        <h3 style="margin: 0; color: #334155; font-size: 1.2rem;">
            Resultados: <span id="cantidadResultados">0</span> estudiante(s) encontrado(s)
        </h3>
    </div>
    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: #f8fafc;">
            <tr>
                <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">DNI</th>
                <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Nombre Completo</th>
                <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Email</th>
                <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Edad</th>
                <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Ciudad</th>
                <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Nivel Estudios</th>
                <th style="padding: 1rem 1.5rem; text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Inscripciones</th>
            </tr>
        </thead>
        <tbody id="resultadosBody">
        </tbody>
    </table>
</div>

<style>
    .empty-state {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        margin-top: 2rem;
    }
    .empty-state .icon {
        font-size: 4rem;
        color: #cbd5e1;
        margin-bottom: 1rem;
    }
    .empty-state p {
        font-size: 1.1rem;
        color: #64748b;
        margin-bottom: 1.5rem;
    }
    .btn-primary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.8rem 1.5rem;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 700;
        display: inline-block;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        opacity: 0.9;
        transform: translateY(-2px);
    }
    #searchInput:focus {
        outline: none;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
    }
    tbody tr {
        border-bottom: 1px solid #f1f5f9;
        transition: background 0.2s ease;
    }
    tbody tr:hover {
        background: #f8fafc;
    }
    tbody td {
        padding: 1rem 1.5rem;
        color: #334155;
    }
    .highlight {
        background: #fef3c7;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-weight: 600;
    }
</style>

<script>
    let timeoutId = null;
    const searchInput = document.getElementById('searchInput');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const emptyState = document.getElementById('emptyState');
    const resultadosTabla = document.getElementById('resultadosTabla');
    const resultadosBody = document.getElementById('resultadosBody');
    const cantidadResultados = document.getElementById('cantidadResultados');
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Limpiar timeout anterior
        if (timeoutId) {
            clearTimeout(timeoutId);
        }
        
        // Si la búsqueda es muy corta, mostrar estado vacío
        if (query.length < 2) {
            emptyState.style.display = 'block';
            resultadosTabla.style.display = 'none';
            emptyState.innerHTML = `
                <p>Escribe al menos 2 caracteres para buscar.</p>
            `;
            return;
        }
        
        // Mostrar indicador de carga
        loadingIndicator.style.display = 'block';
        
        // Esperar 500ms antes de hacer la búsqueda (debounce)
        timeoutId = setTimeout(() => {
            buscarEstudiantes(query);
        }, 500);
    });
    
    async function buscarEstudiantes(query) {
        try {
            const response = await fetch(`{% url 'administracion:api_buscar_estudiantes' %}?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            loadingIndicator.style.display = 'none';
            
            if (data.estudiantes.length === 0) {
                emptyState.style.display = 'block';
                resultadosTabla.style.display = 'none';
                emptyState.innerHTML = `
                    <p>No se encontraron estudiantes con "<strong>${query}</strong>".</p>
                `;
                return;
            }
            
            // Mostrar resultados
            emptyState.style.display = 'none';
            resultadosTabla.style.display = 'block';
            cantidadResultados.textContent = data.estudiantes.length;
            
            // Construir tabla
            resultadosBody.innerHTML = '';
            data.estudiantes.forEach(est => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${est.dni}</strong></td>
                    <td>${est.nombre_completo}</td>
                    <td>${est.correo}</td>
                    <td>${est.edad}</td>
                    <td>${est.ciudad}</td>
                    <td>${est.nivel_estudios}</td>
                    <td>
                        <span style="background: #dbeafe; color: #1e40af; padding: 0.4rem 0.8rem; border-radius: 8px; font-weight: 600; font-size: 0.85rem;">
                            ${est.inscripciones}
                        </span>
                    </td>
                `;
                resultadosBody.appendChild(row);
            });
            
        } catch (error) {
            console.error('Error al buscar:', error);
            loadingIndicator.style.display = 'none';
            emptyState.style.display = 'block';
            resultadosTabla.style.display = 'none';
            emptyState.innerHTML = `
                
                <p>Error al realizar la búsqueda. Por favor, intenta de nuevo.</p>
            `;
        }
    }
    
    // Focus automático en el input al cargar
    searchInput.focus();
</script>
{% endblock %}


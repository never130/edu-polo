{% extends 'dashboard/base_dashboard.html' %}
{% load static %}
{% load l10n %}

{% block title %}Estadísticas Detalladas - Admin{% endblock %}

{% block user_role %}Administrador{% endblock %}

{% block sidebar_menu %}
<li><a href="{% url 'dashboard_admin' %}"><i class="fa-solid fa-home"></i> Inicio</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'administracion:panel_cursos' %}"><i class="fa-solid fa-book"></i> Gestión Cursos</a></li>
<li><a href="{% url 'administracion:panel_comisiones' %}"><i class="fa-solid fa-users-rectangle"></i> Gestión Comisiones</a></li>
{% endif %}
<li><a href="{% url 'administracion:panel_inscripciones' %}"><i class="fa-solid fa-clipboard-list"></i> Inscripciones</a></li>
{% if es_admin_completo or es_mesa_entrada %}
<li><a href="{% url 'empresas:mesa_entrada_list' %}"><i class="fa-solid fa-building"></i> Solicitudes Empresas</a></li>
{% endif %}
{% if es_admin_completo %}
<li><a href="{% url 'empresas:gestion_empresas' %}"><i class="fa-solid fa-building"></i> Gestión Empresas</a></li>
<li><a href="{% url 'empresas:turnos_admin' %}"><i class="fa-solid fa-calendar"></i> Turnos Empresas</a></li>
{% endif %}
{% if es_admin_completo or es_mesa_entrada %}
<li><a href="{% url 'empresas:turnos_hoy' %}"><i class="fa-solid fa-calendar-check"></i> Asistencia Empresas</a></li>
{% endif %}
{% if es_admin_completo %}
<li><a href="{% url 'administracion:gestion_usuarios' %}"><i class="fa-solid fa-users-cog"></i> Gestión Usuarios</a></li>
{% endif %}
<li><a href="{% url 'administracion:buscador_estudiantes' %}"><i class="fa-solid fa-search"></i> Buscar Estudiantes</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'administracion:panel_polos' %}"><i class="fa-solid fa-map-marker-alt"></i> Polos</a></li>
{% endif %}
{% if es_admin_completo %}
<li><a href="{% url 'administracion:estadisticas' %}" class="active"><i class="fa-solid fa-chart-bar"></i> Estadísticas</a></li>
{% endif %}
<li><a href="{% url 'administracion:panel_asistencia' %}"><i class="fa-solid fa-calendar-check"></i> Asistencias</a></li>
<li><a href="{% url 'usuario:mi_perfil' %}"><i class="fa-solid fa-user"></i> Mi Perfil</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'admin:index' %}"><i class="fa-solid fa-cogs"></i> Django Admin</a></li>
{% endif %}
{% endblock %}

{% block content %}
<div class="page-hero">
    <div class="page-hero__content">
        <div>
            <h1 class="page-hero__title">Estadísticas</h1>
            <p class="page-hero__subtitle">Análisis de cursos, inscripciones y asistencias.</p>
        </div>

        <div class="page-hero__actions">
            <a href="{% url 'administracion:exportar_estadisticas_estudiantes_curso' %}" class="action-btn" target="_blank">
                <i class="fa-solid fa-file-excel"></i>
                Exportar
            </a>
        </div>
    </div>
</div>

<div class="section">
    <div class="section__header">
        <h2 class="section__title">Resumen</h2>
    </div>

    <div class="stats-grid">
        <div class="stat-card stat-card--courses">
            <div class="stat-icon"><i class="fa-solid fa-book"></i></div>
            <div class="stat-content">
                <div class="stat-label">Total cursos</div>
                <div class="stat-number">{{ total_cursos }}</div>
            </div>
        </div>

        <div class="stat-card stat-card--students">
            <div class="stat-icon"><i class="fa-solid fa-user-group"></i></div>
            <div class="stat-content">
                <div class="stat-label">Total estudiantes</div>
                <div class="stat-number">{{ total_estudiantes }}</div>
            </div>
        </div>

        <div class="stat-card stat-card--enrollments">
            <div class="stat-icon"><i class="fa-solid fa-clipboard-check"></i></div>
            <div class="stat-content">
                <div class="stat-label">Inscripciones activas</div>
                <div class="stat-number">{{ total_inscripciones }}</div>
            </div>
        </div>


    </div>
</div>

<div class="section">
    <div class="section__header">
        <h2 class="section__title">Gráficos</h2>
    </div>

    <div class="charts-container">
        <div class="card">
            <div class="card__header">
                <h3 class="card__title">Estudiantes por curso</h3>
            </div>
            <div class="chart-box">
                <canvas id="chartBarras"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card__header">
                <h3 class="card__title">Inscripciones por estado</h3>
            </div>
            <div class="chart-box">
                <canvas id="chartInscripcionesEstado"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card__header card__header--between">
                <h3 class="card__title">Estado de asistencia</h3>
                <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
                    <select id="filtroCursoAsistencia" style="padding:0.5rem 0.75rem; border-radius:10px; border:1px solid #e2e8f0; font-weight:700; color:#0f172a; background:white;">
                        <option value="">Todos los cursos</option>
                    </select>
                    <select id="filtroComisionAsistencia" disabled style="padding:0.5rem 0.75rem; border-radius:10px; border:1px solid #e2e8f0; font-weight:700; color:#0f172a; background:white;">
                        <option value="">Todas las comisiones</option>
                    </select>
                </div>
            </div>
            <div style="padding: 0 1.25rem; margin: 0.5rem 0 0; color:#64748b; font-size:0.92rem; line-height:1.3; overflow-wrap:anywhere;">
                Muestra el estado de asistencia de inscripciones confirmadas: Al día (≥ 75%), En riesgo (&lt; 75%) y Pendiente de carga (sin asistencia registrada). Filtrá por curso y comisión.
            </div>
            <div class="chart-box">
                <canvas id="chartAsistenciaRangos"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card__header">
                <h3 class="card__title">Asistencia semanal (por polo)</h3>
            </div>
            <div class="chart-box">
                <canvas id="chartAsistenciaSemanal"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card__header">
                <h3 class="card__title">Demanda vs oferta (polo × franja)</h3>
            </div>
            <div class="chart-box">
                <canvas id="chartDemandaOferta"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card__header card__header--between">
                <h3 class="card__title">Ocupación vs asistencia (por comisión)</h3>
                <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
                    <select id="filtroPoloOcupacion" style="padding:0.5rem 0.75rem; border-radius:10px; border:1px solid #e2e8f0; font-weight:700; color:#0f172a; background:white;">
                        <option value="">Todos los polos</option>
                    </select>
                    <select id="filtroCursoOcupacion" style="padding:0.5rem 0.75rem; border-radius:10px; border:1px solid #e2e8f0; font-weight:700; color:#0f172a; background:white;">
                        <option value="">Todos los cursos</option>
                    </select>
                    <select id="filtroFranjaOcupacion" style="padding:0.5rem 0.75rem; border-radius:10px; border:1px solid #e2e8f0; font-weight:700; color:#0f172a; background:white;">
                        <option value="">Todas las franjas</option>
                    </select>
                </div>
            </div>
            <div style="padding: 0 1.25rem; margin: 0.5rem 0 0; color:#64748b; font-size:0.92rem; line-height:1.3; overflow-wrap:anywhere;">
                Eje X: % ocupación (confirmados / cupo). Eje Y: % asistencia promedio. Las comisiones sin registro aparecen separadas.
            </div>
            <div class="chart-box">
                <canvas id="chartOcupacionVsAsistencia"></canvas>
            </div>
        </div>
        
        <div class="card">
            <div class="card__header card__header--between">
                <h3 class="card__title">Edad (rangos)</h3>
                <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
                    <select id="filtroCursoEdad" style="padding:0.5rem 0.75rem; border-radius:10px; border:1px solid #e2e8f0; font-weight:700; color:#0f172a; background:white;">
                        <option value="">Todos los cursos</option>
                    </select>
                    <select id="filtroComisionEdad" disabled style="padding:0.5rem 0.75rem; border-radius:10px; border:1px solid #e2e8f0; font-weight:700; color:#0f172a; background:white;">
                        <option value="">Todas las comisiones</option>
                    </select>
                </div>
            </div>
            <div style="padding: 0 1.25rem; margin: 0.5rem 0 0; color:#64748b; font-size:0.92rem; line-height:1.3; overflow-wrap:anywhere;">
                Distribución por rangos de edad (según fecha de nacimiento) para inscripciones confirmadas. Filtrá por curso y comisión.
            </div>
            <div class="chart-box">
                <canvas id="chartEdadRangos"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card__header">
                <h3 class="card__title">Género (estudiantes)</h3>
            </div>
            <div class="chart-box">
                <canvas id="chartGenero"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card__header card__header--between">
        <h2 class="card__title">Cursos</h2>
        <div class="card__subtitle">Cantidad de alumnos por curso</div>
    </div>

    {% if cursos_con_alumnos %}
    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>Curso</th>
                <th>Total Alumnos</th>
                <th>Porcentaje del Total</th>
                <th>Estado</th>
            </tr>
        </thead>
            <tbody>
                {% for curso in cursos_con_alumnos %}
                <tr>
                <td><strong>{{ curso.nombre }}</strong></td>
                <td>{{ curso.total_alumnos }}</td>
                <td>
                    {% if total_inscripciones > 0 %}
                        {{ curso.porcentaje_total }}%
                    {% else %}
                        0%
                    {% endif %}
                </td>
                <td>
                    {% if curso.estado == 'Abierto' %}
                        <span class="badge badge-success">✅ Abierto</span>
                    {% else %}
                        <span class="badge badge-danger">❌ Cerrado</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state__icon"><i class="fa-regular fa-folder-open"></i></div>
        <p>No hay datos de cursos disponibles.</p>
    </div>
    {% endif %}
</div>


<style>
    .page-hero {
        background: linear-gradient(135deg, rgba(255, 81, 47, 0.95) 0%, rgba(240, 152, 25, 0.95) 100%);
        padding: 2rem;
        border-radius: 18px;
        color: white;
        margin-bottom: 1.75rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    .page-hero__content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .page-hero__title {
        margin: 0;
        font-size: 2rem;
        font-weight: 800;
        letter-spacing: -0.02em;
    }

    .page-hero__subtitle {
        margin: 0.4rem 0 0;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
    }

    .page-hero__actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .action-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        color: white;
        text-decoration: none;
        font-weight: 700;
        background: rgba(255, 255, 255, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.35);
        transition: transform 0.2s ease, background 0.2s ease;
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.26);
        transform: translateY(-1px);
    }

    .section {
        margin-bottom: 1.75rem;
    }

    .section__header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .section__title {
        margin: 0;
        font-size: 1.15rem;
        font-weight: 800;
        color: #0f172a;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 1rem;
    }

    .stat-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 1.25rem 1.25rem;
        box-shadow: 0 4px 16px rgba(15, 23, 42, 0.06);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }

    .stat-icon {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.35rem;
        flex: 0 0 auto;
        box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    }

    .stat-card--courses .stat-icon { background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); }
    .stat-card--students .stat-icon { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .stat-card--enrollments .stat-icon { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); }
    .stat-card--attendance .stat-icon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }

    .stat-label {
        font-size: 0.85rem;
        color: #64748b;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 900;
        color: #0f172a;
        line-height: 1.1;
        margin-top: 0.25rem;
    }

    .charts-container {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1rem;
    }

    .charts-container--single {
        grid-template-columns: minmax(0, 1fr);
    }

    .card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(15, 23, 42, 0.06);
        overflow: hidden;
    }

    .card__header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f1f5f9;
    }

    .card__header--between {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .card__title {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 900;
        color: #0f172a;
    }

    .card__subtitle {
        color: #64748b;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .chart-box {
        padding: 1rem 1.25rem 1.25rem;
    }

    .chart-box canvas {
        width: 100% !important;
        max-height: 360px;
    }

    .table-wrapper {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 780px;
    }

    thead {
        background: #f8fafc;
    }

    th {
        padding: 0.95rem 1.25rem;
        text-align: left;
        color: #64748b;
        font-weight: 800;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        font-size: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
        white-space: nowrap;
    }

    td {
        padding: 1rem 1.25rem;
        color: #0f172a;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    tbody tr:hover {
        background: #f8fafc;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        border-radius: 9999px;
        font-weight: 800;
        font-size: 0.78rem;
        white-space: nowrap;
    }

    .badge-success {
        background: #dcfce7;
        color: #166534;
    }

    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .empty-state {
        text-align: center;
        padding: 2.5rem 1.25rem;
    }

    .empty-state__icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 0.75rem;
        border-radius: 18px;
        background: #f1f5f9;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
    }

    .empty-state p {
        margin: 0;
        color: #64748b;
        font-weight: 600;
    }

    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .charts-container {
            grid-template-columns: minmax(0, 1fr);
        }
    }

    @media (max-width: 640px) {
        .page-hero {
            padding: 1.5rem;
        }

        .page-hero__title {
            font-size: 1.7rem;
        }

        .stats-grid {
            grid-template-columns: minmax(0, 1fr);
        }

        .stat-number {
            font-size: 1.8rem;
        }

        table {
            min-width: 680px;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Datos desde Django
    const datosGrafico = {{ datos_grafico_json|safe }};
    const asistenciaRangos = {{ asistencia_rangos_json|safe }};
    const edadRangos = {{ edad_rangos_json|safe }};
    const datosInscripcionesEstado = {{ inscripciones_estado_json|safe }};
    const datosGenero = {{ genero_grafico_json|safe }};
    const asistenciaSemanal = {{ asistencia_semanal_json|safe }};
    const demandaOferta = {{ demanda_oferta_json|safe }};
    const ocupacionAsistencia = {{ ocupacion_asistencia_json|safe }};
    
    // Configuración global de fuentes para Chart.js
    Chart.defaults.font.family = "'Be Vietnam Pro', sans-serif";
    
    // Preparar datos para los gráficos
    const labels = datosGrafico.map(d => d.nombre);
    const valores = datosGrafico.map(d => d.cantidad);
    
    // Colores vibrantes para los gráficos
    const colores = [
        'rgba(59, 130, 246, 0.8)',   // Azul
        'rgba(16, 185, 129, 0.8)',   // Verde
        'rgba(236, 72, 153, 0.8)',   // Rosa
        'rgba(245, 158, 11, 0.8)',   // Naranja
        'rgba(139, 92, 246, 0.8)',   // Púrpura
        'rgba(239, 68, 68, 0.8)',    // Rojo
        'rgba(20, 184, 166, 0.8)',   // Teal
        'rgba(251, 146, 60, 0.8)',   // Naranja claro
    ];
    
    const normalizarTop = (items, limite, etiquetaOtros) => {
        const ordenados = [...items].sort((a, b) => b.valor - a.valor);
        const top = ordenados.slice(0, Math.max(limite, 0));
        const resto = ordenados.slice(Math.max(limite, 0));
        const sumaResto = resto.reduce((acc, item) => acc + (item.valor || 0), 0);
        if (sumaResto > 0) {
            top.push({ etiqueta: etiquetaOtros, valor: sumaResto });
        }
        return top;
    };

    // Gráfico de Barras (Top cursos por cantidad)
    const ctxBarras = document.getElementById('chartBarras').getContext('2d');
    const itemsCantidad = labels.map((etiqueta, i) => ({ etiqueta, valor: valores[i] || 0 }));
    const topCantidad = normalizarTop(itemsCantidad, 15, 'Otros');
    const labelsCantidad = topCantidad.map(i => i.etiqueta);
    const valoresCantidad = topCantidad.map(i => i.valor);

    new Chart(ctxBarras, {
        type: 'bar',
        data: {
            labels: labelsCantidad,
            datasets: [{
                label: 'Cantidad de Estudiantes',
                data: valoresCantidad,
                backgroundColor: labelsCantidad.map((_, i) => colores[i % colores.length]),
                borderColor: labelsCantidad.map((_, i) => colores[i % colores.length].replace('0.8', '1')),
                borderWidth: 2,
                borderRadius: 8,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: { size: 12 }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: { size: 11 }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // Inscripciones por estado
    const elInscripcionesEstado = document.getElementById('chartInscripcionesEstado');
    if (elInscripcionesEstado) {
        const ctxInscripcionesEstado = elInscripcionesEstado.getContext('2d');
        const labelsEstado = (datosInscripcionesEstado || []).map(d => d.nombre);
        const valoresEstado = (datosInscripcionesEstado || []).map(d => Number(d.cantidad || 0));

        new Chart(ctxInscripcionesEstado, {
            type: 'doughnut',
            data: {
                labels: labelsEstado,
                datasets: [{
                    label: 'Inscripciones',
                    data: valoresEstado,
                    backgroundColor: labelsEstado.map((_, i) => colores[i % colores.length]),
                    borderColor: '#ffffff',
                    borderWidth: 3,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 12 },
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    const elChartAsistenciaSemanal = document.getElementById('chartAsistenciaSemanal');
    if (elChartAsistenciaSemanal && asistenciaSemanal && Array.isArray(asistenciaSemanal.series)) {
        const ctx = elChartAsistenciaSemanal.getContext('2d');
        const weeks = (asistenciaSemanal.weeks || []).map(w => {
            if (!w || typeof w !== 'string' || w.length < 10) return String(w || '');
            return `${w.slice(8, 10)}/${w.slice(5, 7)}`;
        });
        const datasets = (asistenciaSemanal.series || []).map((s, i) => ({
            label: s.polo || `Polo ${i + 1}`,
            data: (s.data || []).map(v => Number(v || 0)),
            borderColor: colores[i % colores.length].replace('0.8', '1'),
            backgroundColor: colores[i % colores.length],
            pointRadius: 3,
            tension: 0.25,
        }));

        new Chart(ctx, {
            type: 'line',
            data: { labels: weeks, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${Number(c.parsed.y || 0).toFixed(1)}%` } }
                },
                scales: {
                    y: { beginAtZero: true, max: 100, ticks: { callback: (v) => `${v}%` } },
                    x: { grid: { display: false } },
                }
            }
        });
    }

    const ctxAsistenciaRangos = document.getElementById('chartAsistenciaRangos').getContext('2d');

    const labelsAsistencia = ['Al día', 'En riesgo', 'Pendiente de carga'];
    const coloresAsistencia = [
        'rgba(16, 185, 129, 0.85)',
        'rgba(245, 158, 11, 0.85)',
        'rgba(148, 163, 184, 0.85)',
    ];

    const getRangosAsistencia = (cursoId, comisionId) => {
        const global = (asistenciaRangos && asistenciaRangos.global) ? asistenciaRangos.global : {};
        const porCurso = (asistenciaRangos && asistenciaRangos.por_curso) ? asistenciaRangos.por_curso : {};
        const porComision = (asistenciaRangos && asistenciaRangos.por_comision) ? asistenciaRangos.por_comision : {};

        if (comisionId && Object.prototype.hasOwnProperty.call(porComision, String(comisionId))) {
            return porComision[String(comisionId)] || {};
        }

        if (cursoId && Object.prototype.hasOwnProperty.call(porCurso, String(cursoId))) {
            return porCurso[String(cursoId)] || {};
        }

        return global || {};
    };

    const valoresDesdeRangos = (rangos) => {
        const sinDatos = Number((rangos && rangos.sin_registro) || 0);
        const alDia = Number((rangos && rangos.rango_75_100) || 0);
        const enRiesgo = Number((rangos && rangos.rango_0_49) || 0) + Number((rangos && rangos.rango_50_74) || 0);
        return [alDia, enRiesgo, sinDatos];
    };

    const chartAsistenciaRangos = new Chart(ctxAsistenciaRangos, {
        type: 'doughnut',
        data: {
            labels: labelsAsistencia,
            datasets: [{
                label: 'Inscripciones',
                data: valoresDesdeRangos(getRangosAsistencia('', '')),
                backgroundColor: coloresAsistencia,
                borderColor: '#ffffff',
                borderWidth: 3,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    const elFiltroCursoAsistencia = document.getElementById('filtroCursoAsistencia');
    const elFiltroComisionAsistencia = document.getElementById('filtroComisionAsistencia');

    const setOptions = (selectEl, options, placeholder) => {
        if (!selectEl) return;
        const prev = selectEl.value;
        selectEl.innerHTML = '';
        const optPlaceholder = document.createElement('option');
        optPlaceholder.value = '';
        optPlaceholder.textContent = placeholder;
        selectEl.appendChild(optPlaceholder);

        for (const o of options) {
            const opt = document.createElement('option');
            opt.value = String(o.value);
            opt.textContent = o.label;
            selectEl.appendChild(opt);
        }

        if (Array.from(selectEl.options).some(o => o.value === prev)) {
            selectEl.value = prev;
        }
    };

    const cargarCursosAsistencia = () => {
        if (!elFiltroCursoAsistencia) return;
        const cursos = (asistenciaRangos && asistenciaRangos.cursos) ? asistenciaRangos.cursos : [];
        const opciones = [...cursos]
            .map(c => ({ value: c.id, label: c.nombre || `Curso ${c.id}` }))
            .sort((a, b) => String(a.label).localeCompare(String(b.label)));

        setOptions(elFiltroCursoAsistencia, opciones, 'Todos los cursos');
    };

    const cargarComisionesAsistencia = (cursoId) => {
        if (!elFiltroComisionAsistencia) return;
        const comisiones = (asistenciaRangos && asistenciaRangos.comisiones) ? asistenciaRangos.comisiones : [];
        const opciones = [...comisiones]
            .filter(c => String(c.curso_id) === String(cursoId))
            .map(c => ({ value: c.id, label: c.label || `Comisión ${c.id}` }));

        setOptions(elFiltroComisionAsistencia, opciones, 'Todas las comisiones');
        elFiltroComisionAsistencia.disabled = opciones.length === 0;
    };

    const actualizarAsistenciaRangos = () => {
        const cursoId = elFiltroCursoAsistencia ? elFiltroCursoAsistencia.value : '';
        const comisionId = elFiltroComisionAsistencia ? elFiltroComisionAsistencia.value : '';
        const rangos = getRangosAsistencia(cursoId, comisionId);

        chartAsistenciaRangos.data.datasets[0].data = valoresDesdeRangos(rangos);
        chartAsistenciaRangos.update();
    };

    cargarCursosAsistencia();
    if (elFiltroCursoAsistencia && elFiltroComisionAsistencia) {
        elFiltroCursoAsistencia.addEventListener('change', () => {
            const cursoId = elFiltroCursoAsistencia.value;
            elFiltroComisionAsistencia.value = '';

            if (cursoId) {
                cargarComisionesAsistencia(cursoId);
            } else {
                cargarComisionesAsistencia('__none__');
                elFiltroComisionAsistencia.disabled = true;
            }

            actualizarAsistenciaRangos();
        });

        elFiltroComisionAsistencia.addEventListener('change', () => {
            actualizarAsistenciaRangos();
        });
    }

    const elFiltroCursoEdad = document.getElementById('filtroCursoEdad');
    const elFiltroComisionEdad = document.getElementById('filtroComisionEdad');

    const ctxEdadRangos = document.getElementById('chartEdadRangos').getContext('2d');

    const getRangosEdad = (cursoId, comisionId) => {
        const global = (edadRangos && edadRangos.global) ? edadRangos.global : {};
        const porCurso = (edadRangos && edadRangos.por_curso) ? edadRangos.por_curso : {};
        const porComision = (edadRangos && edadRangos.por_comision) ? edadRangos.por_comision : {};

        if (comisionId && Object.prototype.hasOwnProperty.call(porComision, String(comisionId))) {
            return porComision[String(comisionId)] || {};
        }

        if (cursoId && Object.prototype.hasOwnProperty.call(porCurso, String(cursoId))) {
            return porCurso[String(cursoId)] || {};
        }

        return global || {};
    };

    const construirEdadDataset = (rangos) => {
        const base = [
            { key: 'rango_6_9', label: '6–9', color: 'rgba(59, 130, 246, 0.85)' },
            { key: 'rango_10_12', label: '10–12', color: 'rgba(16, 185, 129, 0.85)' },
            { key: 'rango_13_16', label: '13–16', color: 'rgba(245, 158, 11, 0.85)' },
            { key: 'rango_17_18', label: '17–18', color: 'rgba(139, 92, 246, 0.85)' },
            { key: 'rango_19_24', label: '19–24', color: 'rgba(236, 72, 153, 0.85)' },
            { key: 'rango_25_34', label: '25–34', color: 'rgba(251, 146, 60, 0.85)' },
            { key: 'rango_35_plus', label: '35+', color: 'rgba(239, 68, 68, 0.85)' },
        ];

        const items = [...base];
        const menor6 = Number((rangos && rangos.menor_6) || 0);
        const noInformada = Number((rangos && rangos.no_informada) || 0);

        if (menor6 > 0) {
            items.unshift({ key: 'menor_6', label: '< 6', color: 'rgba(148, 163, 184, 0.85)' });
        }
        if (noInformada > 0) {
            items.push({ key: 'no_informada', label: 'No informada', color: 'rgba(100, 116, 139, 0.85)' });
        }

        return {
            labels: items.map(i => i.label),
            data: items.map(i => Number((rangos && rangos[i.key]) || 0)),
            colors: items.map(i => i.color),
        };
    };

    const inicialEdad = construirEdadDataset(getRangosEdad('', ''));

    const chartEdadRangos = new Chart(ctxEdadRangos, {
        type: 'bar',
        data: {
            labels: inicialEdad.labels,
            datasets: [{
                label: 'Inscripciones confirmadas',
                data: inicialEdad.data,
                backgroundColor: inicialEdad.colors,
                borderRadius: 10,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1,
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: '#334155', font: { weight: '700' } },
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(148, 163, 184, 0.25)' },
                    ticks: { color: '#64748b', precision: 0 },
                }
            }
        }
    });

    const cargarCursosEdad = () => {
        if (!elFiltroCursoEdad) return;
        const cursos = (edadRangos && edadRangos.cursos) ? edadRangos.cursos : [];
        const opciones = [...cursos]
            .map(c => ({ value: c.id, label: c.nombre || `Curso ${c.id}` }))
            .sort((a, b) => String(a.label).localeCompare(String(b.label)));

        setOptions(elFiltroCursoEdad, opciones, 'Todos los cursos');
    };

    const cargarComisionesEdad = (cursoId) => {
        if (!elFiltroComisionEdad) return;
        const comisiones = (edadRangos && edadRangos.comisiones) ? edadRangos.comisiones : [];
        const opciones = [...comisiones]
            .filter(c => String(c.curso_id) === String(cursoId))
            .map(c => ({ value: c.id, label: c.label || `Comisión ${c.id}` }));

        setOptions(elFiltroComisionEdad, opciones, 'Todas las comisiones');
        elFiltroComisionEdad.disabled = opciones.length === 0;
    };

    const actualizarEdadRangos = () => {
        const cursoId = elFiltroCursoEdad ? elFiltroCursoEdad.value : '';
        const comisionId = elFiltroComisionEdad ? elFiltroComisionEdad.value : '';
        const rangos = getRangosEdad(cursoId, comisionId);
        const dataset = construirEdadDataset(rangos);

        chartEdadRangos.data.labels = dataset.labels;
        chartEdadRangos.data.datasets[0].data = dataset.data;
        chartEdadRangos.data.datasets[0].backgroundColor = dataset.colors;
        chartEdadRangos.update();
    };

    cargarCursosEdad();
    if (elFiltroCursoEdad && elFiltroComisionEdad) {
        elFiltroCursoEdad.addEventListener('change', () => {
            const cursoId = elFiltroCursoEdad.value;
            elFiltroComisionEdad.value = '';

            if (cursoId) {
                cargarComisionesEdad(cursoId);
            } else {
                cargarComisionesEdad('__none__');
                elFiltroComisionEdad.disabled = true;
            }

            actualizarEdadRangos();
        });

        elFiltroComisionEdad.addEventListener('change', () => {
            actualizarEdadRangos();
        });
    }

    const elChartDemandaOferta = document.getElementById('chartDemandaOferta');
    if (elChartDemandaOferta && demandaOferta) {
        const ctx = elChartDemandaOferta.getContext('2d');
        const polos = demandaOferta.polos || [];
        const franjas = (demandaOferta.franjas || []).filter(f => String(f) !== 'Sin horario');
        const base = (demandaOferta.points || []).filter(p => String(p.franja) !== 'Sin horario');

        const colorRatio = (ratio) => {
            if (ratio >= 1) return 'rgba(239, 68, 68, 0.80)';
            if (ratio >= 0.75) return 'rgba(245, 158, 11, 0.80)';
            return 'rgba(16, 185, 129, 0.80)';
        };

        const points = base.map(p => {
            const cupo = Number(p.cupo || 0);
            const demanda = Number(p.demanda || 0);
            const ratio = cupo > 0 ? (demanda / cupo) : 0;
            return {
                x: franjas.indexOf(p.franja),
                y: polos.indexOf(p.polo),
                r: Math.max(4, Math.min(18, ratio * 10)),
                _meta: { polo: p.polo, franja: p.franja, demanda, cupo, ratio },
                _color: colorRatio(ratio),
            };
        }).filter(p => p.x >= 0 && p.y >= 0);

        new Chart(ctx, {
            type: 'bubble',
            data: {
                datasets: [{
                    data: points,
                    backgroundColor: points.map(p => p._color),
                    borderColor: 'rgba(255, 255, 255, 0.9)',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: (items) => {
                                const m = items[0]?.raw?._meta;
                                return m ? `${m.polo} · ${m.franja}` : '';
                            },
                            label: (c) => {
                                const m = c.raw?._meta;
                                if (!m) return '';
                                return `Demanda/Cupo: ${m.demanda}/${m.cupo} (${(m.ratio * 100).toFixed(0)}%)`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        min: -0.5,
                        max: Math.max(franjas.length - 0.5, 0.5),
                        ticks: { stepSize: 1, callback: (v) => franjas[v] || '' },
                        grid: { display: false },
                    },
                    y: {
                        min: -0.5,
                        max: Math.max(polos.length - 0.5, 0.5),
                        ticks: { stepSize: 1, callback: (v) => polos[v] || '' },
                        grid: { color: 'rgba(148, 163, 184, 0.18)' },
                    }
                }
            }
        });
    }

    const elChartOcupacionVsAsistencia = document.getElementById('chartOcupacionVsAsistencia');
    const elFiltroPoloOcupacion = document.getElementById('filtroPoloOcupacion');
    const elFiltroCursoOcupacion = document.getElementById('filtroCursoOcupacion');
    const elFiltroFranjaOcupacion = document.getElementById('filtroFranjaOcupacion');

    if (ocupacionAsistencia) {
        const franjasOcupacion = (ocupacionAsistencia.franjas || []).filter(f => String(f) !== 'Sin horario');
        setOptions(elFiltroPoloOcupacion, ocupacionAsistencia.polos || [], 'Todos los polos');
        setOptions(elFiltroCursoOcupacion, ocupacionAsistencia.cursos || [], 'Todos los cursos');
        setOptions(elFiltroFranjaOcupacion, franjasOcupacion.map(f => ({ value: f, label: f })), 'Todas las franjas');
    }

    if (elChartOcupacionVsAsistencia && ocupacionAsistencia) {
        const ctx = elChartOcupacionVsAsistencia.getContext('2d');
        const base = (ocupacionAsistencia.puntos || []).filter(p => String(p.franja) !== 'Sin horario');

        const filtrar = () => {
            const poloId = elFiltroPoloOcupacion ? (elFiltroPoloOcupacion.value || '') : '';
            const cursoId = elFiltroCursoOcupacion ? (elFiltroCursoOcupacion.value || '') : '';
            const franja = elFiltroFranjaOcupacion ? (elFiltroFranjaOcupacion.value || '') : '';
            return base.filter(p => {
                if (poloId && String(p.polo_id) !== String(poloId)) return false;
                if (cursoId && String(p.curso_id) !== String(cursoId)) return false;
                if (franja && String(p.franja) !== String(franja)) return false;
                return true;
            });
        };

        const build = () => {
            const con = [];
            const sin = [];
            for (const p of filtrar()) {
                const x = Number(p.ocupacion_pct || 0);
                const yRaw = (p.asistencia_pct === null || typeof p.asistencia_pct === 'undefined') ? null : Number(p.asistencia_pct || 0);
                const row = { x, y: (yRaw === null ? 0 : yRaw), _meta: p };
                if (yRaw === null) sin.push(row); else con.push(row);
            }
            return [
                { label: 'Con asistencia', data: con, backgroundColor: 'rgba(59, 130, 246, 0.70)' },
                { label: 'Sin registro', data: sin, backgroundColor: 'rgba(148, 163, 184, 0.70)' },
            ];
        };

        const chart = new Chart(ctx, {
            type: 'scatter',
            data: { datasets: build() },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            title: (items) => {
                                const m = items[0]?.raw?._meta;
                                if (!m) return '';
                                return `${m.curso || 'Curso'} · Comisión #${m.comision_id || ''}`;
                            },
                            label: (c) => {
                                const m = c.raw?._meta;
                                if (!m) return '';
                                const asis = (m.asistencia_pct === null || typeof m.asistencia_pct === 'undefined') ? 'Sin registro' : `${Number(m.asistencia_pct || 0).toFixed(1)}%`;
                                return [`Ocupación: ${Number(m.ocupacion_pct || 0).toFixed(1)}% · Asistencia: ${asis}`, `${m.polo || ''} · ${m.franja || ''}`];
                            }
                        }
                    }
                },
                scales: {
                    x: { beginAtZero: true, max: 100, ticks: { callback: (v) => `${v}%` } },
                    y: { beginAtZero: true, max: 100, ticks: { callback: (v) => `${v}%` } },
                }
            }
        });

        const actualizar = () => {
            chart.data.datasets = build();
            chart.update();
        };

        if (elFiltroPoloOcupacion) elFiltroPoloOcupacion.addEventListener('change', actualizar);
        if (elFiltroCursoOcupacion) elFiltroCursoOcupacion.addEventListener('change', actualizar);
        if (elFiltroFranjaOcupacion) elFiltroFranjaOcupacion.addEventListener('change', actualizar);
    }

    const ctxGenero = document.getElementById('chartGenero').getContext('2d');
    const labelsGenero = (datosGenero || []).map(d => d.nombre);
    const valoresGenero = (datosGenero || []).map(d => d.cantidad);

    new Chart(ctxGenero, {
        type: 'doughnut',
        data: {
            labels: labelsGenero,
            datasets: [{
                label: 'Estudiantes',
                data: valoresGenero,
                backgroundColor: labelsGenero.map((_, i) => colores[i % colores.length]),
                borderColor: '#ffffff',
                borderWidth: 3,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}

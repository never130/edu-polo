{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Cambiar Contraseña{% endblock %}

{% block user_role %}{{ tipo_usuario|default:"Usuario" }}{% endblock %}

{% block sidebar_menu %}
{% if es_admin or es_mesa_entrada %}
    {# Menú para Administrador y Mesa de Entrada #}
    <li><a href="{% url 'dashboard_admin' %}"><i class="fa-solid fa-home"></i> Inicio</a></li>
    {% if es_admin_completo %}
    <li><a href="{% url 'administracion:panel_cursos' %}"><i class="fa-solid fa-book"></i> Gestión Cursos</a></li>
    <li><a href="{% url 'administracion:panel_comisiones' %}"><i class="fa-solid fa-users-rectangle"></i> Gestión Comisiones</a></li>
    {% endif %}
    <li><a href="{% url 'administracion:panel_inscripciones' %}"><i class="fa-solid fa-clipboard-list"></i> Inscripciones</a></li>
    {% if es_admin_completo %}
    <li><a href="{% url 'administracion:gestion_usuarios' %}"><i class="fa-solid fa-users-cog"></i> Gestión Usuarios</a></li>
    {% endif %}
    <li><a href="{% url 'administracion:buscador_estudiantes' %}"><i class="fa-solid fa-search"></i> Buscar Estudiantes</a></li>
    {% if es_admin_completo %}
    <li><a href="{% url 'administracion:panel_polos' %}"><i class="fa-solid fa-map-marker-alt"></i> Polos</a></li>
    {% endif %}
    {% if es_admin_completo %}
    <li><a href="{% url 'administracion:estadisticas' %}"><i class="fa-solid fa-chart-bar"></i> Estadísticas</a></li>
    {% endif %}
    <li><a href="{% url 'administracion:panel_asistencia' %}"><i class="fa-solid fa-calendar-check"></i> Asistencias</a></li>
    {% if es_admin_completo %}
    <li><a href="{% url 'administracion:docentes_cursos' %}"><i class="fa-solid fa-chalkboard-teacher"></i> Docentes y Cursos</a></li>
    {% endif %}
    <li><a href="{% url 'empresas:mesa_entrada_list' %}"><i class="fa-solid fa-building"></i> Solicitudes Empresas</a></li>
    <li><a href="{% url 'empresas:gestion_empresas' %}"><i class="fa-solid fa-building"></i> Gestión Empresas</a></li>
    <li><a href="{% url 'usuario:mi_perfil' %}"><i class="fa-solid fa-user"></i> Mi Perfil</a></li>
    {% if es_admin_completo %}
    <li><a href="{% url 'admin:index' %}"><i class="fa-solid fa-cogs"></i> Django Admin</a></li>
    {% endif %}
{% elif es_docente %}
    {# Menú para Docentes #}
    <li><a href="{% url 'dashboard_docente' %}"><i class="fa-solid fa-home"></i> Inicio</a></li>
    <li><a href="{% url 'administracion:mis_cursos_docente' %}"><i class="fa-solid fa-chalkboard"></i> Mis Cursos</a></li>
    <li><a href="{% url 'administracion:panel_asistencia' %}"><i class="fa-solid fa-calendar-check"></i> Asistencias</a></li>
    <li><a href="{% url 'administracion:materiales_docente' %}"><i class="fa-solid fa-folder-open"></i> Materiales</a></li>
    <li><a href="{% url 'administracion:estudiantes_docente' %}"><i class="fa-solid fa-users"></i> Estudiantes</a></li>
    <li><a href="{% url 'usuario:mi_perfil' %}" class="active"><i class="fa-solid fa-user"></i> Mi Perfil</a></li>
    {% if persona.es_mayor_de_edad %}
    <li><a href="{% url 'empresas:mi_empresa' %}"><i class="fa-solid fa-building"></i> Mi Empresa / Startup</a></li>
    {% endif %}
{% else %}
    {# Menú para Estudiantes y otros usuarios #}
    <li><a href="{% url 'dashboard_estudiante' %}"><i class="fa-solid fa-home"></i> Inicio</a></li>
    <li><a href="{% url 'usuario:mi_perfil' %}" class="active"><i class="fa-solid fa-user"></i> Mi Perfil</a></li>
    {% if persona.es_mayor_de_edad %}
    <li><a href="{% url 'empresas:mi_empresa' %}"><i class="fa-solid fa-building"></i> Mi Empresa / Startup</a></li>
    {% endif %}
{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Cambiar Contraseña</h2>
    <p>Actualiza tu contraseña de acceso</p>
</div>

{% if messages %}
    <ul class="messages">
        {% for message in messages %}
            <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
    </ul>
{% endif %}

<div class="form-card">
    <div class="security-info">
        <span class="security-icon"></span>
        <div>
            <h3>Seguridad de tu Contraseña</h3>
            <ul>
                <li>Debe tener al menos 6 caracteres</li>
                <li>Usa una combinación de letras y números</li>
                <li>No compartas tu contraseña con nadie</li>
            </ul>
        </div>
    </div>

    <form method="post" id="formContrasena">
        {% csrf_token %}
        
        <div class="form-section">
            <div class="form-group">
                <label for="contrasena_actual" class="required">Contraseña Actual</label>
                <div class="password-input-wrapper">
                    <input type="password" name="contrasena_actual" id="contrasena_actual" required placeholder="Ingresa tu contraseña actual">
                    <button type="button" class="toggle-password" onclick="togglePassword('contrasena_actual')">
                        Ver
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="contrasena_nueva" class="required">Nueva Contraseña</label>
                <div class="password-input-wrapper">
                    <input type="password" name="contrasena_nueva" id="contrasena_nueva" required placeholder="Mínimo 6 caracteres" minlength="6">
                    <button type="button" class="toggle-password" onclick="togglePassword('contrasena_nueva')">
                        Ver
                    </button>
                </div>
                <small class="password-strength" id="passwordStrength"></small>
            </div>
            
            <div class="form-group">
                <label for="contrasena_confirmar" class="required">Confirmar Nueva Contraseña</label>
                <div class="password-input-wrapper">
                    <input type="password" name="contrasena_confirmar" id="contrasena_confirmar" required placeholder="Repite la nueva contraseña" minlength="6">
                    <button type="button" class="toggle-password" onclick="togglePassword('contrasena_confirmar')">
                        Ver
                    </button>
                </div>
                <small class="password-match" id="passwordMatch"></small>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                Cambiar Contraseña
            </button>
            <a href="{% url 'usuario:mi_perfil' %}" class="btn btn-secondary">
                Cancelar
            </a>
        </div>
    </form>
</div>

<style>
    .page-header {
        margin-bottom: 2rem;
    }
    .page-header h2 {
        font-size: 2.2rem;
        color: #334155;
        margin-bottom: 0.5rem;
    }
    .page-header p {
        color: #64748b;
        font-size: 1.05rem;
    }
    
    .messages {
        list-style: none;
        padding: 0;
        margin-bottom: 1.5rem;
    }
    .messages li {
        padding: 1rem 1.5rem;
        border-radius: 10px;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    .messages li.success {
        background: #d1fae5;
        color: #065f46;
    }
    .messages li.error {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .form-card {
        background: white;
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 600px;
        margin: 0 auto;
    }
    
    .security-info {
        background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
        padding: 1.5rem;
        border-radius: 12px;
        display: flex;
        gap: 1.5rem;
        margin-bottom: 2rem;
        border-left: 4px solid #3b82f6;
    }
    
    .security-icon {
        font-size: 2.5rem;
    }
    
    .security-info h3 {
        color: #1e40af;
        font-size: 1.2rem;
        margin-bottom: 0.8rem;
    }
    
    .security-info ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .security-info li {
        color: #3b82f6;
        margin-bottom: 0.4rem;
        font-size: 0.95rem;
    }
    
    .form-section {
        margin-bottom: 2rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.6rem;
        color: #334155;
        font-weight: 600;
        font-size: 0.95rem;
    }
    
    .form-group label.required::after {
        content: ' *';
        color: #ef4444;
        margin-left: 4px;
    }
    
    .password-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }
    
    .password-input-wrapper input {
        width: 100%;
        padding: 1rem 3rem 1rem 1.2rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f8fafc;
        font-family: 'Be Vietnam Pro', sans-serif;
    }
    
    .password-input-wrapper input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
    
    .toggle-password {
        position: absolute;
        right: 1rem;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.3rem;
        padding: 0.5rem;
        transition: transform 0.2s ease;
    }
    
    .toggle-password:hover {
        transform: scale(1.1);
    }
    
    .password-strength,
    .password-match {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .password-strength.weak {
        color: #ef4444;
    }
    
    .password-strength.medium {
        color: #f59e0b;
    }
    
    .password-strength.strong {
        color: #10b981;
    }
    
    .password-match.match {
        color: #10b981;
    }
    
    .password-match.no-match {
        color: #ef4444;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .btn {
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
        border: none;
        font-size: 1rem;
        display: inline-block;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    
    .btn-secondary {
        background: #e2e8f0;
        color: #334155;
    }
    
    .btn-secondary:hover {
        background: #cbd5e1;
    }
    
    @media (max-width: 768px) {
        .form-card {
            padding: 1.5rem;
            margin: 1rem;
        }
        
        .security-info {
            flex-direction: column;
            text-align: center;
        }
        
        .btn {
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
        }
        
        .form-actions {
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .form-actions .btn {
            width: 100%;
        }
    }
</style>

<script>
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
            input.type = 'text';
        } else {
            input.type = 'password';
        }
    }
    
    // Validar fortaleza de contraseña
    document.getElementById('contrasena_nueva').addEventListener('input', function() {
        const password = this.value;
        const strengthIndicator = document.getElementById('passwordStrength');
        
        if (password.length === 0) {
            strengthIndicator.textContent = '';
            return;
        }
        
        if (password.length < 6) {
            strengthIndicator.textContent = '❌ Muy débil (mínimo 6 caracteres)';
            strengthIndicator.className = 'password-strength weak';
        } else if (password.length < 10 && !/\d/.test(password)) {
            strengthIndicator.textContent = '⚠️ Débil (agrega números)';
            strengthIndicator.className = 'password-strength medium';
        } else if (password.length >= 10 && /\d/.test(password)) {
            strengthIndicator.textContent = '✅ Fuerte';
            strengthIndicator.className = 'password-strength strong';
        } else {
            strengthIndicator.textContent = '✓ Aceptable';
            strengthIndicator.className = 'password-strength medium';
        }
    });
    
    // Validar que las contraseñas coincidan
    document.getElementById('contrasena_confirmar').addEventListener('input', function() {
        const password = document.getElementById('contrasena_nueva').value;
        const confirm = this.value;
        const matchIndicator = document.getElementById('passwordMatch');
        
        if (confirm.length === 0) {
            matchIndicator.textContent = '';
            return;
        }
        
        if (password === confirm) {
            matchIndicator.textContent = '✅ Las contraseñas coinciden';
            matchIndicator.className = 'password-match match';
        } else {
            matchIndicator.textContent = '❌ Las contraseñas no coinciden';
            matchIndicator.className = 'password-match no-match';
        }
    });
    
    // Validación antes de enviar
    document.getElementById('formContrasena').addEventListener('submit', function(e) {
        const password = document.getElementById('contrasena_nueva').value;
        const confirm = document.getElementById('contrasena_confirmar').value;
        
        if (password !== confirm) {
            e.preventDefault();
            alert('❌ Las contraseñas no coinciden. Por favor, verifica e intenta de nuevo.');
            return false;
        }
        
        if (password.length < 6) {
            e.preventDefault();
            alert('❌ La contraseña debe tener al menos 6 caracteres.');
            return false;
        }
    });
</script>
{% endblock %}



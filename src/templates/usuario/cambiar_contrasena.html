{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Cambiar ContraseÃ±a - Edu-Polo{% endblock %}

{% block user_role %}{{ tipo_usuario|default:"Usuario" }}{% endblock %}

{% block sidebar_menu %}
{% if es_admin or es_mesa_entrada %}
    {# MenÃº para Administrador y Mesa de Entrada #}
    <li><a href="{% url 'dashboard_admin' %}"><span class="icon">ğŸ </span> Inicio</a></li>
    <li><a href="{% url 'administracion:panel_cursos' %}"><span class="icon">ğŸ“š</span> GestiÃ³n Cursos</a></li>
    <li><a href="{% url 'administracion:panel_comisiones' %}"><span class="icon">ğŸ“‹</span> GestiÃ³n Comisiones</a></li>
    <li><a href="{% url 'administracion:panel_inscripciones' %}"><span class="icon">âœ…</span> Inscripciones</a></li>
    {% if es_admin_completo %}
    <li><a href="{% url 'administracion:gestion_usuarios' %}"><span class="icon">ğŸ‘¥</span> GestiÃ³n Usuarios</a></li>
    {% endif %}
    <li><a href="{% url 'administracion:buscador_estudiantes' %}"><span class="icon">ğŸ”</span> Buscar Estudiantes</a></li>
    {% if es_admin_completo %}
    <li><a href="{% url 'administracion:panel_polos' %}"><span class="icon">ğŸ¢</span> Polos</a></li>
    {% endif %}
    <li><a href="{% url 'administracion:estadisticas' %}"><span class="icon">ğŸ“Š</span> EstadÃ­sticas</a></li>
    <li><a href="{% url 'administracion:panel_asistencia' %}"><span class="icon">ğŸ“</span> Asistencias</a></li>
    <li><a href="{% url 'administracion:docentes_cursos' %}"><span class="icon">ğŸ‘¨â€ğŸ«</span> Docentes y Cursos</a></li>
    <li><a href="{% url 'usuario:mi_perfil' %}"><span class="icon">ğŸ‘¤</span> Mi Perfil</a></li>
    {% if es_admin_completo %}
    <li><a href="{% url 'admin:index' %}"><span class="icon">âš™ï¸</span> Django Admin</a></li>
    {% endif %}
{% elif es_docente %}
    {# MenÃº para Docentes #}
    <li><a href="{% url 'dashboard_docente' %}"><span class="icon">ğŸ </span> Inicio</a></li>
    <li><a href="{% url 'administracion:mis_cursos_docente' %}"><span class="icon">ğŸ“š</span> Mis Cursos</a></li>
    <li><a href="{% url 'administracion:panel_asistencia' %}"><span class="icon">ğŸ“</span> Asistencias</a></li>
    <li><a href="{% url 'administracion:materiales_docente' %}"><span class="icon">ğŸ“</span> Materiales</a></li>
    <li><a href="{% url 'administracion:estudiantes_docente' %}"><span class="icon">ğŸ‘¥</span> Estudiantes</a></li>
    <li><a href="{% url 'usuario:mi_perfil' %}" class="active"><span class="icon">ğŸ‘¤</span> Mi Perfil</a></li>
{% else %}
    {# MenÃº para Estudiantes y otros usuarios #}
    <li><a href="{% url 'dashboard_estudiante' %}"><span class="icon">ğŸ </span> Inicio</a></li>
    <li><a href="{% url 'usuario:mi_perfil' %}" class="active"><span class="icon">ğŸ‘¤</span> Mi Perfil</a></li>
{% endif %}
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ”’ Cambiar ContraseÃ±a</h2>
    <p>Actualiza tu contraseÃ±a de acceso</p>
</div>

{% if messages %}
    <ul class="messages">
        {% for message in messages %}
            <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
    </ul>
{% endif %}

<div class="form-card">
    <div class="security-info">
        <span class="security-icon">ğŸ›¡ï¸</span>
        <div>
            <h3>Seguridad de tu ContraseÃ±a</h3>
            <ul>
                <li>âœ“ Debe tener al menos 6 caracteres</li>
                <li>âœ“ Usa una combinaciÃ³n de letras y nÃºmeros</li>
                <li>âœ“ No compartas tu contraseÃ±a con nadie</li>
            </ul>
        </div>
    </div>

    <form method="post" id="formContrasena">
        {% csrf_token %}
        
        <div class="form-section">
            <div class="form-group">
                <label for="contrasena_actual" class="required">ContraseÃ±a Actual</label>
                <div class="password-input-wrapper">
                    <input type="password" name="contrasena_actual" id="contrasena_actual" required placeholder="Ingresa tu contraseÃ±a actual">
                    <button type="button" class="toggle-password" onclick="togglePassword('contrasena_actual')">
                        ğŸ‘ï¸
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="contrasena_nueva" class="required">Nueva ContraseÃ±a</label>
                <div class="password-input-wrapper">
                    <input type="password" name="contrasena_nueva" id="contrasena_nueva" required placeholder="MÃ­nimo 6 caracteres" minlength="6">
                    <button type="button" class="toggle-password" onclick="togglePassword('contrasena_nueva')">
                        ğŸ‘ï¸
                    </button>
                </div>
                <small class="password-strength" id="passwordStrength"></small>
            </div>
            
            <div class="form-group">
                <label for="contrasena_confirmar" class="required">Confirmar Nueva ContraseÃ±a</label>
                <div class="password-input-wrapper">
                    <input type="password" name="contrasena_confirmar" id="contrasena_confirmar" required placeholder="Repite la nueva contraseÃ±a" minlength="6">
                    <button type="button" class="toggle-password" onclick="togglePassword('contrasena_confirmar')">
                        ğŸ‘ï¸
                    </button>
                </div>
                <small class="password-match" id="passwordMatch"></small>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                ğŸ”’ Cambiar ContraseÃ±a
            </button>
            <a href="{% url 'usuario:mi_perfil' %}" class="btn btn-secondary">
                Cancelar
            </a>
        </div>
    </form>
</div>

<style>
    .page-header {
        margin-bottom: 2rem;
    }
    .page-header h2 {
        font-size: 2.2rem;
        color: #334155;
        margin-bottom: 0.5rem;
    }
    .page-header p {
        color: #64748b;
        font-size: 1.05rem;
    }
    
    .messages {
        list-style: none;
        padding: 0;
        margin-bottom: 1.5rem;
    }
    .messages li {
        padding: 1rem 1.5rem;
        border-radius: 10px;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    .messages li.success {
        background: #d1fae5;
        color: #065f46;
    }
    .messages li.error {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .form-card {
        background: white;
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 600px;
        margin: 0 auto;
    }
    
    .security-info {
        background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
        padding: 1.5rem;
        border-radius: 12px;
        display: flex;
        gap: 1.5rem;
        margin-bottom: 2rem;
        border-left: 4px solid #3b82f6;
    }
    
    .security-icon {
        font-size: 2.5rem;
    }
    
    .security-info h3 {
        color: #1e40af;
        font-size: 1.2rem;
        margin-bottom: 0.8rem;
    }
    
    .security-info ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .security-info li {
        color: #3b82f6;
        margin-bottom: 0.4rem;
        font-size: 0.95rem;
    }
    
    .form-section {
        margin-bottom: 2rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.6rem;
        color: #334155;
        font-weight: 600;
        font-size: 0.95rem;
    }
    
    .form-group label.required::after {
        content: ' *';
        color: #ef4444;
        margin-left: 4px;
    }
    
    .password-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }
    
    .password-input-wrapper input {
        width: 100%;
        padding: 1rem 3rem 1rem 1.2rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f8fafc;
        font-family: 'Be Vietnam Pro', sans-serif;
    }
    
    .password-input-wrapper input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
    
    .toggle-password {
        position: absolute;
        right: 1rem;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.3rem;
        padding: 0.5rem;
        transition: transform 0.2s ease;
    }
    
    .toggle-password:hover {
        transform: scale(1.1);
    }
    
    .password-strength,
    .password-match {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .password-strength.weak {
        color: #ef4444;
    }
    
    .password-strength.medium {
        color: #f59e0b;
    }
    
    .password-strength.strong {
        color: #10b981;
    }
    
    .password-match.match {
        color: #10b981;
    }
    
    .password-match.no-match {
        color: #ef4444;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .btn {
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
        border: none;
        font-size: 1rem;
        display: inline-block;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    
    .btn-secondary {
        background: #e2e8f0;
        color: #334155;
    }
    
    .btn-secondary:hover {
        background: #cbd5e1;
    }
    
    @media (max-width: 768px) {
        .form-card {
            padding: 1.5rem;
            margin: 1rem;
        }
        
        .security-info {
            flex-direction: column;
            text-align: center;
        }
        
        .btn {
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
        }
        
        .form-actions {
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .form-actions .btn {
            width: 100%;
        }
    }
</style>

<script>
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
            input.type = 'text';
        } else {
            input.type = 'password';
        }
    }
    
    // Validar fortaleza de contraseÃ±a
    document.getElementById('contrasena_nueva').addEventListener('input', function() {
        const password = this.value;
        const strengthIndicator = document.getElementById('passwordStrength');
        
        if (password.length === 0) {
            strengthIndicator.textContent = '';
            return;
        }
        
        if (password.length < 6) {
            strengthIndicator.textContent = 'âŒ Muy dÃ©bil (mÃ­nimo 6 caracteres)';
            strengthIndicator.className = 'password-strength weak';
        } else if (password.length < 10 && !/\d/.test(password)) {
            strengthIndicator.textContent = 'âš ï¸ DÃ©bil (agrega nÃºmeros)';
            strengthIndicator.className = 'password-strength medium';
        } else if (password.length >= 10 && /\d/.test(password)) {
            strengthIndicator.textContent = 'âœ… Fuerte';
            strengthIndicator.className = 'password-strength strong';
        } else {
            strengthIndicator.textContent = 'âœ“ Aceptable';
            strengthIndicator.className = 'password-strength medium';
        }
    });
    
    // Validar que las contraseÃ±as coincidan
    document.getElementById('contrasena_confirmar').addEventListener('input', function() {
        const password = document.getElementById('contrasena_nueva').value;
        const confirm = this.value;
        const matchIndicator = document.getElementById('passwordMatch');
        
        if (confirm.length === 0) {
            matchIndicator.textContent = '';
            return;
        }
        
        if (password === confirm) {
            matchIndicator.textContent = 'âœ… Las contraseÃ±as coinciden';
            matchIndicator.className = 'password-match match';
        } else {
            matchIndicator.textContent = 'âŒ Las contraseÃ±as no coinciden';
            matchIndicator.className = 'password-match no-match';
        }
    });
    
    // ValidaciÃ³n antes de enviar
    document.getElementById('formContrasena').addEventListener('submit', function(e) {
        const password = document.getElementById('contrasena_nueva').value;
        const confirm = document.getElementById('contrasena_confirmar').value;
        
        if (password !== confirm) {
            e.preventDefault();
            alert('âŒ Las contraseÃ±as no coinciden. Por favor, verifica e intenta de nuevo.');
            return false;
        }
        
        if (password.length < 6) {
            e.preventDefault();
            alert('âŒ La contraseÃ±a debe tener al menos 6 caracteres.');
            return false;
        }
    });
</script>
{% endblock %}



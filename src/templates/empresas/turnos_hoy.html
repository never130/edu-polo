{% extends 'dashboard/base_dashboard.html' %}

{% block title %}Asistencia Empresas{% endblock %}

{% block user_role %}{{ tipo_usuario|default:"Mesa de Entrada" }}{% endblock %}

{% block sidebar_menu %}
{% if tipo_usuario == 'Administrador' %}
<li><a href="{% url 'dashboard_admin' %}"><i class="fa-solid fa-home"></i> Inicio</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'administracion:panel_cursos' %}"><i class="fa-solid fa-book"></i> Gestión Cursos</a></li>
<li><a href="{% url 'administracion:panel_comisiones' %}"><i class="fa-solid fa-users-rectangle"></i> Gestión Comisiones</a></li>
{% endif %}
<li><a href="{% url 'administracion:panel_inscripciones' %}"><i class="fa-solid fa-clipboard-list"></i> Inscripciones</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'empresas:mesa_entrada_list' %}"><i class="fa-solid fa-building"></i> Solicitudes Empresas</a></li>
<li><a href="{% url 'empresas:gestion_empresas' %}"><i class="fa-solid fa-building"></i> Gestión Empresas</a></li>
<li><a href="{% url 'empresas:turnos_admin' %}"><i class="fa-solid fa-calendar"></i> Turnos Empresas</a></li>
{% endif %}
<li><a href="{% url 'empresas:turnos_hoy' %}" class="active"><i class="fa-solid fa-calendar-check"></i> Asistencia Empresas</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'administracion:gestion_usuarios' %}"><i class="fa-solid fa-users-cog"></i> Gestión Usuarios</a></li>
{% endif %}
<li><a href="{% url 'administracion:buscador_estudiantes' %}"><i class="fa-solid fa-search"></i> Buscar Estudiantes</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'administracion:panel_polos' %}"><i class="fa-solid fa-map-marker-alt"></i> Polos</a></li>
{% endif %}
{% if es_admin_completo %}
<li><a href="{% url 'administracion:estadisticas' %}"><i class="fa-solid fa-chart-pie"></i> Estadísticas</a></li>
{% endif %}
<li><a href="{% url 'administracion:panel_asistencia' %}"><i class="fa-solid fa-calendar-check"></i> Asistencias</a></li>
<li><a href="{% url 'usuario:mi_perfil' %}"><i class="fa-solid fa-user"></i> Mi Perfil</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'admin:index' %}"><i class="fa-solid fa-cogs"></i> Django Admin</a></li>
{% endif %}
{% else %}
<li><a href="{% url 'dashboard_admin' %}"><i class="fa-solid fa-home"></i> Inicio</a></li>
<li><a href="{% url 'administracion:panel_inscripciones' %}"><i class="fa-solid fa-clipboard-list"></i> Inscripciones</a></li>
{% if es_admin_completo %}
<li><a href="{% url 'empresas:mesa_entrada_list' %}"><i class="fa-solid fa-building"></i> Solicitudes Empresas</a></li>
<li><a href="{% url 'empresas:turnos_admin' %}"><i class="fa-solid fa-calendar"></i> Turnos Empresas</a></li>
{% endif %}
<li><a href="{% url 'empresas:turnos_hoy' %}" class="active"><i class="fa-solid fa-calendar-check"></i> Asistencia Empresas</a></li>
<li><a href="{% url 'usuario:mi_perfil' %}"><i class="fa-solid fa-user"></i> Mi Perfil</a></li>
{% endif %}
{% endblock %}

{% block content %}
<style>
    .card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(15, 23, 42, 0.06);
        padding: 1.25rem 1.5rem;
        min-width: 0;
    }
    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding: 0.55rem 0.4rem; border-bottom: 1px solid #f1f5f9; text-align:left; vertical-align:top; }
    th { border-bottom: 1px solid #e2e8f0; color:#0f172a; font-weight:900; }
    .badge {
        display:inline-block;
        padding: 0.2rem 0.55rem;
        border-radius: 999px;
        font-weight: 900;
        background:#f1f5f9;
        color:#334155;
        font-size: 0.8rem;
        white-space:nowrap;
    }
    .acciones { display:flex; gap:0.45rem; flex-wrap:wrap; }
    .filtro-empresa { min-width: 0; flex: 1 1 260px; }
    th.col-acciones, td.col-acciones { min-width: 0; }
    @media (min-width: 760px) {
        th.col-acciones, td.col-acciones { min-width: 360px; }
    }
</style>

<div class="page-header">
    <div style="display:flex; justify-content:space-between; gap:1rem; align-items:flex-start; flex-wrap:wrap;">
        <div>
            <h2>Asistencia Empresas</h2>
            <p>Marcá la asistencia de los turnos del día {{ fecha|date:"d/m/Y" }}.</p>
        </div>
        <div>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end;">
                <form method="post" style="margin:0;">
                    {% csrf_token %}
                    <input type="hidden" name="accion" value="marcar_todos">
                    <input type="hidden" name="estado" value="presente">
                    <input type="hidden" name="fecha" value="{{ fecha|date:'Y-m-d' }}">
                    <input type="hidden" name="empresa_id" value="{{ empresa_id }}">
                    <button type="submit" class="btn btn-secondary">Sin marcar → Presente</button>
                </form>
                <form method="post" action="{% url 'empresas:turnos_cerrar_dia' %}" style="margin:0;">
                    {% csrf_token %}
                    <input type="hidden" name="fecha" value="{{ fecha|date:'Y-m-d' }}">
                    <input type="hidden" name="empresa_id" value="{{ empresa_id }}">
                    <button type="submit" class="btn btn-primary">Cerrar día: sin marcar a ausentes</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% if messages %}
    <div class="dashboard-alerts">
        {% for message in messages %}
            <div class="dashboard-alert dashboard-alert--{{ message.tags|default:'info' }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<div class="card">
    <form method="get" style="display:flex; gap:0.75rem; align-items:end; flex-wrap:wrap; margin:0 0 0.85rem 0;">
        <div style="display:flex; flex-direction:column; gap:0.25rem;">
            <label style="font-weight:900; color:#0f172a;">Fecha</label>
            <input type="date" name="fecha" value="{{ fecha|date:'Y-m-d' }}" style="border:1px solid #cbd5e1; border-radius:10px; padding:0.55rem 0.65rem; background:white;">
        </div>
        <div class="filtro-empresa" style="display:flex; flex-direction:column; gap:0.25rem;">
            <label style="font-weight:900; color:#0f172a;">Empresa</label>
            <select name="empresa_id" style="border:1px solid #cbd5e1; border-radius:10px; padding:0.55rem 0.65rem; background:white;">
                <option value="">Todas</option>
                {% for e in empresas %}
                    <option value="{{ e.id }}" {% if empresa_id == e.id|stringformat:"s" %}selected{% endif %}>{{ e.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-secondary">Ver</button>
    </form>

    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin:0 0 0.85rem 0;">
        <span class="badge">Total: {{ resumen_dia.total }}</span>
        <span class="badge" style="background:#dcfce7; color:#166534;">Presente: {{ resumen_dia.presente }}</span>
        <span class="badge" style="background:#fee2e2; color:#991b1b;">Ausente: {{ resumen_dia.ausente }}</span>
        <span class="badge">Sin marcar: {{ resumen_dia.sin_marcar }}</span>
    </div>

    {% if turnos %}
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Empresa</th>
                        <th>Horario</th>
                        <th>Estado</th>
                        <th class="col-acciones">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in turnos %}
                        <tr>
                            <td style="font-weight:900;">{{ t.empresa.nombre }}</td>
                            <td style="white-space:nowrap;">{{ t.hora_desde|time:"H:i" }} - {{ t.hora_hasta|time:"H:i" }}</td>
                            <td>
                                {% if t.estado_asistencia == 'presente' %}
                                    <span class="badge" style="background:#dcfce7; color:#166534;">Presente</span>
                                {% elif t.estado_asistencia == 'ausente' %}
                                    <span class="badge" style="background:#fee2e2; color:#991b1b;">Ausente</span>
                                {% else %}
                                    <span class="badge">Sin marcar</span>
                                {% endif %}
                            </td>
                            <td class="col-acciones">
                                <div class="acciones">
                                    <form method="post" style="margin:0;">
                                        {% csrf_token %}
                                        <input type="hidden" name="accion" value="marcar">
                                        <input type="hidden" name="turno_id" value="{{ t.id }}">
                                        <input type="hidden" name="estado" value="presente">
                                        <input type="hidden" name="fecha" value="{{ fecha|date:'Y-m-d' }}">
                                        <input type="hidden" name="empresa_id" value="{{ empresa_id }}">
                                        <button type="submit" class="btn btn-secondary">Presente</button>
                                    </form>
                                    <form method="post" style="margin:0;">
                                        {% csrf_token %}
                                        <input type="hidden" name="accion" value="marcar">
                                        <input type="hidden" name="turno_id" value="{{ t.id }}">
                                        <input type="hidden" name="estado" value="ausente">
                                        <input type="hidden" name="fecha" value="{{ fecha|date:'Y-m-d' }}">
                                        <input type="hidden" name="empresa_id" value="{{ empresa_id }}">
                                        <button type="submit" class="btn btn-secondary">Ausente</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div>No hay turnos cargados para esta fecha.</div>
    {% endif %}
</div>
{% endblock %}

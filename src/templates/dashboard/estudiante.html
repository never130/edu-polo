{% extends 'dashboard/base_dashboard.html' %}
{% load static %}
{% load l10n %}

{% block title %}Dashboard Estudiante{% endblock %}

{% block user_role %}Estudiante{% endblock %}

{% block sidebar_menu %}
<li><a href="{% url 'dashboard_estudiante' %}" class="active"><i class="fa-solid fa-home"></i> Inicio</a></li>
<li><a href="{% url 'cursos:ver_disponibles' %}"><i class="fa-solid fa-book-open"></i> Cursos Disponibles</a></li>
<li><a href="{% url 'cursos:mis_inscripciones' %}"><i class="fa-solid fa-graduation-cap"></i> Mis Inscripciones</a></li>
<li><a href="{% url 'usuario:gestionar_tutores' %}"><i class="fa-solid fa-chalkboard-teacher"></i> Mis Tutores</a></li>
<li><a href="{% url 'usuario:mi_progreso' %}"><i class="fa-solid fa-chart-line"></i> Mi Progreso</a></li>
<li><a href="{% url 'usuario:mi_perfil' %}"><i class="fa-solid fa-user"></i> Mi Perfil</a></li>

{% endblock %}

{% block content %}
<div class="page-header">
    <h2>¡Bienvenido/a, {{ user.first_name }}!</h2>
    <p>Continúa donde lo dejaste y completa tus cursos</p>
</div>

{% if messages %}
    <div class="dashboard-alerts">
        {% for message in messages %}
            <div class="dashboard-alert dashboard-alert--{{ message.tags|default:'info' }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if lista_espera_count or preinscripto_count %}
    <div class="dashboard-alerts">
        <div class="dashboard-alert dashboard-alert--warning">
            <div style="font-weight: 800; margin-bottom: 0.25rem;">Estado de tus inscripciones</div>
            {% if lista_espera_count %}
                <div>Tenés <strong>{{ lista_espera_count }}</strong> inscripción(es) en <strong>lista de espera</strong>. No estás inscripto/a hasta que sea confirmada.</div>
            {% endif %}
            {% if preinscripto_count %}
                <div style="margin-top: 0.25rem;">Tenés <strong>{{ preinscripto_count }}</strong> pre-inscripción(es) <strong>pendiente(s) de confirmación</strong>. Aún no estás inscripto/a hasta que se confirme.</div>
            {% endif %}
            <div style="margin-top: 0.75rem;">
                <a href="{% url 'cursos:mis_inscripciones' %}" class="dashboard-alert-link">Ver detalle en Mis Inscripciones</a>
            </div>
        </div>
    </div>
{% endif %}

<div class="dashboard-layout">
    <!-- Left Column: Active Courses -->
    <div class="main-column">
        <h3 class="section-title">Tus Cursos Activos</h3>
        
        {% if cursos_activos %}
            <div class="active-courses-list">
                {% for curso in cursos_activos %}
                {% with lower_name=curso.nombre|lower %}
                <div class="course-card-horizontal">
                    <div class="course-img-wrapper">
                        <img
                             class="course-img js-pollinations-course-img"
                             alt="{{ curso.nombre }}"
                             loading="lazy"
                             referrerpolicy="no-referrer"
                             data-course-name="{{ curso.nombre|default:'' }}"
                             data-course-desc="{{ curso.descripcion|default:''|striptags|truncatechars:200 }}"
                             src="{% if 'alfabetización' in lower_name or 'alfabetizacion' in lower_name or 'ciudadanía digital' in lower_name or 'ciudadania digital' in lower_name %}https://image.pollinations.ai/prompt/3d%20render%20cartoon%20friendly%20student%20using%20smartphone%20and%20laptop%20digital%20citizenship%20online%20safety%20privacy%20shield%20icons%20social%20media%20colorful%20soft%20lighting?width=600&height=400&nologo=true{% elif 'linux' in lower_name %}https://image.pollinations.ai/prompt/3d%20render%20cartoon%20kid%20learning%20linux%20on%20laptop%20with%20penguin%20plush%20on%20desk%2C%20medium%20shot%2C%20normal%20eyes%2C%20natural%20facial%20proportions%2C%20soft%20smile%2C%20bright%20classroom%2C%20soft%20lighting?width=600&height=400&nologo=true{% elif 'program' in lower_name or 'desarrollo' in lower_name or 'videojuego' in lower_name or 'código' in lower_name or 'codigo' in lower_name or 'gamer' in lower_name or 'gaming' in lower_name or 'game' in lower_name or 'inteligencia artificial' in lower_name or ' ai' in lower_name or 'ai ' in lower_name or ' ia' in lower_name or 'ia ' in lower_name %}https://image.pollinations.ai/prompt/3d%20render%20cartoon%20cute%20character%20working%20with%20computer%20code%20futuristic%20lab%20colorful%20soft%20lighting?width=600&height=400&nologo=true{% elif 'comic' in lower_name or 'cómic' in lower_name or 'ilustración' in lower_name or 'ilustracion' in lower_name or 'historieta' in lower_name or 'historietas' in lower_name or 'viñeta' in lower_name or 'viñetas' in lower_name %}https://image.pollinations.ai/prompt/3d%20render%20comic%20book%20style%20illustration%20of%20dynamic%20comic%20panels%2C%20speech%20bubbles%2C%20ink%20outlines%2C%20halftone%20shading%2C%20vibrant%20colors%2C%20desk%20with%20sketchbook%20and%20pens%2C%20no%20people%2C%20no%20faces%2C%20soft%20studio%20lighting?width=600&height=400&nologo=true{% elif 'diseño' in lower_name or 'arte' in lower_name or 'produccion' in lower_name or 'animación' in lower_name or 'animacion' in lower_name or 'stop motion' in lower_name or 'stopmotion' in lower_name or 'motion' in lower_name %}https://image.pollinations.ai/prompt/3d%20render%20cartoon%20artist%20character%20painting%20on%20canvas%20creative%20studio%20colorful%20palette?width=600&height=400&nologo=true{% elif 'robot' in lower_name or 'arduino' in lower_name or 'sumo' in lower_name or 'bot' in lower_name %}https://image.pollinations.ai/prompt/3d%20render%20cute%20robot%20character%20futuristic%20technology%20glowing%20blue%20lights%20sci-fi?width=600&height=400&nologo=true{% elif 'ingl' in lower_name or 'idioma' in lower_name %}https://image.pollinations.ai/prompt/3d%20render%20cartoon%20character%20reading%20flying%20books%20learning%20languages%20globe%20travel?width=600&height=400&nologo=true{% elif 'ajedrez' in lower_name %}https://image.pollinations.ai/prompt/3d%20render%20cartoon%20top-down%20view%20full%20chessboard%20centered%20on%20table%2C%20all%20pieces%20visible%2C%20wide%20shot%2C%20cozy%20community%20chess%20club%2C%20warm%20inviting%20workshop%20scene%2C%20soft%20studio%20lighting%2C%20no%20people%2C%20no%20faces?width=600&height=400&nologo=true{% elif 'taller' in lower_name or 'explorador' in lower_name %}https://image.pollinations.ai/prompt/3d%20render%20cartoon%20young%20maker%20character%20building%20a%20robot%20with%20tools%20and%20electronics%20in%20a%20modern%20technology%20lab%20colorful%20soft%20lighting?width=600&height=400&nologo=true{% else %}https://image.pollinations.ai/prompt/3d%20render%20cute%20kid%20friendly%20learning%20classroom%20colorful%20soft%20lighting%20playful?width=600&height=400&nologo=true{% endif %}"
                             onerror="this.onerror=null;this.src='https://image.pollinations.ai/prompt/3d%20render%20cute%20kid%20friendly%20learning%20classroom%20colorful%20soft%20lighting%20playful?width=600&height=400&nologo=true';" />
                    </div>
                    <div class="course-content">
                        <div class="course-header-row">
                            <h4 class="course-title">{{ curso.nombre }}</h4>
                            <span class="time-badge">{{ curso.estado_ui|default:"En curso" }}</span>
                        </div>
                        <p class="instructor-name">{{ curso.polo }} - Comisión #{{ curso.comision }}</p>
                        
                        <div class="progress-section">
                            <div class="progress-label">
                                <span>Progreso del curso</span>
                                <span>{{ curso.asistencia }}%</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill" style="width: {{ curso.asistencia|unlocalize }}%;"></div>
                            </div>
                            <div class="course-meta">
                                <span><i class="fa-regular fa-file-alt"></i> {{ curso.total_clases }} clases</span>
                                <span><i class="fa-regular fa-calendar"></i>
                                    {% if curso.estado_ui == 'Por iniciar' %}
                                        Inicio: {% if curso.proxima_fecha %}{{ curso.proxima_fecha|date:"d/m/Y" }}{% else %}{{ curso.horarios|default:"Por definir" }}{% endif %}
                                    {% else %}
                                        Próxima: {% if curso.proxima_fecha %}{{ curso.proxima_fecha|date:"d/m/Y" }}{% else %}{{ curso.horarios|default:"Por definir" }}{% endif %}
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <a href="{% url 'usuario:mi_progreso' %}" class="btn-continue">
                            <i class="fa-solid fa-play-circle"></i> Continuar curso
                        </a>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state-card">
                <div class="empty-icon"><i class="fas fa-graduation-cap" style="font-size: 3rem; color: #cbd5e1;"></i></div>
                <h4>No tienes cursos activos</h4>
                <p>Explora los cursos disponibles e inscríbete para comenzar a aprender.</p>
                <a href="{% url 'cursos:ver_disponibles' %}" class="btn-primary-small">Ver Cursos Disponibles</a>
            </div>
        {% endif %}
    </div>

    <!-- Right Column: Stats -->
    <div class="stats-column">
        <h3 class="section-title">Resumen de Progreso</h3>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon success"><i class="fa-solid fa-check-circle"></i></div>
                <div class="stat-info">
                    <span class="stat-value">0</span> <!-- Placeholder as data not available in context -->
                    <span class="stat-label">Cursos Completados</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning"><i class="fa-solid fa-chart-line"></i></div>
                <div class="stat-info">
                    <span class="stat-value">{{ inscripciones_activas }}</span>
                    <span class="stat-label">En Progreso</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon info"><i class="fa-solid fa-clock"></i></div>
                <div class="stat-info">
                    <span class="stat-value">{{ promedio_general }}%</span>
                    <span class="stat-label">Asistencia Promedio</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon primary"><i class="fa-solid fa-certificate"></i></div>
                <div class="stat-info">
                    <span class="stat-value">{{ certificados }}</span>
                    <span class="stat-label">Certificados</span>
                </div>
            </div>
        </div>

        <div class="mini-courses-list">
            <h4 class="mini-list-title">Cursos Activos</h4>
            {% for curso in cursos_activos %}
            <div class="mini-course-item">
                <div class="mini-icon">
                    <i class="fa-solid fa-circle-check" style="color: #F09819;"></i>
                </div>
                <div class="mini-info">
                    <span class="mini-name">{{ curso.nombre }}</span>
                    <span class="mini-progress">{{ curso.asistencia }}% Completado</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    /* Layout */
    .dashboard-layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        align-items: start;
    }

    .section-title {
        font-size: 1.25rem;
        color: #1e293b;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }

    .dashboard-alerts {
        display: grid;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
    }

    .dashboard-alert {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 14px;
        padding: 1rem 1.25rem;
        box-shadow: 0 4px 16px rgba(15, 23, 42, 0.06);
    }

    .dashboard-alert--success { border-left: 6px solid #10b981; }
    .dashboard-alert--error { border-left: 6px solid #ef4444; }
    .dashboard-alert--warning { border-left: 6px solid #f59e0b; }
    .dashboard-alert--info { border-left: 6px solid #3b82f6; }

    .dashboard-alert-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 800;
        color: #1e40af;
        text-decoration: none;
    }

    .dashboard-alert-link:hover {
        text-decoration: underline;
    }

    /* Active Courses List */
    .active-courses-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .course-card-horizontal {
        display: flex;
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .course-card-horizontal:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .course-img-wrapper {
        width: 280px;
        min-width: 280px;
        position: relative;
        overflow: hidden;
    }

    .course-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .course-content {
        padding: 1.5rem;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .course-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .course-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    .time-badge {
        font-size: 0.75rem;
        color: #64748b;
        background: #f1f5f9;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
    }

    .instructor-name {
        font-size: 0.9rem;
        color: #64748b;
        margin-bottom: 1.5rem;
    }

    .progress-section {
        margin-bottom: 1.5rem;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: #475569;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .progress-track {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.75rem;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #FF512F 0%, #F09819 100%);
        border-radius: 4px;
    }

    .course-meta {
        display: flex;
        gap: 1.5rem;
        font-size: 0.85rem;
        color: #64748b;
    }

    .course-meta i {
        color: #94a3b8;
        margin-right: 0.4rem;
    }

    .btn-continue {
        margin-top: auto;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background: #FF512F;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.2s;
        width: fit-content;
    }

    .btn-continue:hover {
        background: #ea3e1d;
        transform: translateY(-1px);
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.25rem;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .stat-icon.success { background: #dcfce7; color: #16a34a; }
    .stat-icon.warning { background: #ffedd5; color: #f97316; }
    .stat-icon.info { background: #e0f2fe; color: #0284c7; }
    .stat-icon.primary { background: #ffe4e6; color: #e11d48; }

    .stat-info {
        display: flex;
        flex-direction: column;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.2;
    }

    .stat-label {
        font-size: 0.8rem;
        color: #64748b;
    }

    /* Mini Courses List */
    .mini-courses-list {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .mini-list-title {
        font-size: 1rem;
        font-weight: 600;
        color: #475569;
        margin-bottom: 1rem;
    }

    .mini-course-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .mini-course-item:last-child {
        border-bottom: none;
    }

    .mini-icon {
        font-size: 1.2rem;
    }

    .mini-info {
        display: flex;
        flex-direction: column;
    }

    .mini-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: #334155;
    }

    .mini-progress {
        font-size: 0.75rem;
        color: #94a3b8;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .dashboard-layout {
            grid-template-columns: 1fr;
        }
        
        .stats-column {
            order: -1; /* Stats on top on mobile */
        }
        
        .course-card-horizontal {
            flex-direction: column;
        }
        
        .course-img-wrapper {
            width: 100%;
            height: 200px;
        }
    }
    
    .empty-state-card {
        background: white;
        border-radius: 20px;
        padding: 3rem;
        text-align: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    
    .empty-icon { font-size: 3rem; margin-bottom: 1rem; }
    
    .btn-primary-small {
        display: inline-block;
        background: linear-gradient(90deg, #FF512F 0%, #F09819 100%);
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
(function () {
    function stableSeed(input) {
        const str = String(input || '').toLowerCase();
        let h = 2166136261;
        for (let i = 0; i < str.length; i++) {
            h ^= str.charCodeAt(i);
            h = Math.imul(h, 16777619);
        }
        return (h >>> 0) % 1000000000;
    }

    function normalizeText(input) {
        return String(input || '')
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .trim();
    }

    function chooseBasePrompt(courseName) {
        const n = normalizeText(courseName);

        if (n.includes('stop motion') || n.includes('stopmotion')) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, animation stop motion studio desk, clay figures, mini set, camera tripod, storyboard, craft materials';
        }
        if (n.includes('mas juego') || n.includes('mas aprendo')) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, kids learning space, educational board games, puzzles, colorful manipulatives, classroom table, no faces';
        }
        if (n.includes('analisis de datos') || (n.includes('datos') && (n.includes(' ia') || n.includes('ia ') || n.includes('inteligencia artificial')))) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, modern computer lab, dashboards and data charts on screens, AI assistant concept, clean design';
        }
        if (n.includes('chatbot') || n.includes('n8n') || n.includes('automatiz')) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, messaging chatbot concept, automation nodes and connections, modern computer lab';
        }
        if (n.includes('startup')) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, product design desk, laptop, prototype screens, sticky notes, pitch demo scene, no text';
        }
        if (n.includes('robotica star') || (n.includes('robotica') && n.includes(' star'))) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, kids robotics workshop, educational robot kits, colorful sensors, small wheeled robot chassis, building blocks, safe tools, STEM lab';
        }
        if (n.includes('robotica plus') || (n.includes('robotica') && n.includes(' plus'))) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, teen robotics lab, microcontroller boards, sensors, wiring, laptop programming station, robot prototype on workbench';
        }
        if (n.includes('nivel pro') || (n.includes('robotica') && (n.includes(' pro') || n.includes('trayecto avanzado') || n.includes('avanzado')))) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, advanced robotics engineering lab, precision tools, oscilloscope, wiring harnesses, robotic arm prototype on bench, technical workshop';
        }
        if (n.includes('robot') || n.includes('robotica') || n.includes('arduino') || n.includes('sumo') || n.includes('bot')) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, robotics workshop, educational robots, gears, wires, tools, STEM lab';
        }
        if (n.includes('makers kids') || (n.includes('makers') && n.includes('kids'))) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, kids makerspace, 3d printer, colorful filament, simple CAD on tablet, craft tools, creative workshop';
        }
        if (n.includes('makers')) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, makerspace, 3d printer, tools, electronics components, creative workshop';
        }
        if (n.includes('ingl') || n.includes('idioma')) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, language learning classroom, books, flashcards, friendly learning space, no text';
        }
        if (
            n.includes('linux') ||
            n.includes('program') ||
            n.includes('desarrollo') ||
            n.includes('videojuego') ||
            n.includes('codigo') ||
            n.includes('gamer') ||
            n.includes('gaming') ||
            n.includes('game') ||
            n.includes('inteligencia artificial') ||
            /(^|\s)(ai|ia)(\s|$)/.test(n)
        ) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, modern computer lab, coding and science learning, friendly workshop scene';
        }
        if (
            n.includes('comic') ||
            n.includes('ilustracion') ||
            n.includes('historieta') ||
            n.includes('fotografia') ||
            n.includes('diseno') ||
            n.includes('arte') ||
            n.includes('animacion') ||
            n.includes('motion')
        ) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, creative studio desk, camera, drawing tools, art materials, friendly workshop';
        }
        if (n.includes('taller') || n.includes('explorador')) {
            return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, hands-on workshop, tools, craft materials, classroom makers table';
        }

        return 'high quality 3d render, photorealistic, realistic materials, cinematic lighting, global illumination, shallow depth of field, friendly modern classroom workshop scene, educational';
    }

    function buildPollinationsUrl(name, desc) {
        const cleanName = (name || '').trim();
        const base = chooseBasePrompt(cleanName);
        const extra = cleanName;
        const suffix = 'no text, no watermark, no logo, no letters, no words, not cartoon, not illustration, not anime';
        const prompt = extra ? `${base}, ${extra}, ${suffix}` : `${base}, ${suffix}`;
        const seed = stableSeed(cleanName || base);
        return `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=600&height=400&seed=${seed}&nologo=true`;
    }

    function preloadAndSet(img, url) {
        if (!url) return;
        const probe = new Image();
        probe.referrerPolicy = 'no-referrer';
        probe.onload = () => {
            img.src = url;
        };
        probe.onerror = () => {
        };
        probe.src = url;
    }

    function apply() {
        document.querySelectorAll('img.js-pollinations-course-img').forEach((img) => {
            img.referrerPolicy = 'no-referrer';
            const name = img.getAttribute('data-course-name') || img.alt || '';
            const desc = img.getAttribute('data-course-desc') || '';
            const url = buildPollinationsUrl(name, desc);
            preloadAndSet(img, url);
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', apply);
    } else {
        apply();
    }
})();
</script>
{% endblock %}
